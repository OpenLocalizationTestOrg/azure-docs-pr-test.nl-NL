---
title: Hybride verbinding met 2-tier-toepassing | Microsoft Docs
description: Informatie over het implementeren van virtuele apparaten en UDR de omgeving van een toepassing met meerdere lagen maken in Azure
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 8e464348660114f5e99b4739bb7761b7e53ebf99
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 07/11/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="a4620-103">Virtueel apparaat scenario</span><span class="sxs-lookup"><span data-stu-id="a4620-103">Virtual appliance scenario</span></span>
<span data-ttu-id="a4620-104">Een veelvoorkomend scenario tussen groter Azure klant is de noodzaak om een toepassing twee lagen blootgesteld aan Internet, terwijl toegang tot de back-laag van een on-premises datacenter.</span><span class="sxs-lookup"><span data-stu-id="a4620-104">A common scenario among larger Azure customer is the need to provide a two-tiered application exposed to the Internet, while allowing access to the back tier from an on-premises datacenter.</span></span> <span data-ttu-id="a4620-105">Dit document helpt u bij een scenario waarbij de gebruiker gedefinieerde Routes (UDR), een VPN-Gateway en virtuele netwerkapparaten voor het implementeren van een omgeving met twee lagen die voldoet aan de volgende vereisten:</span><span class="sxs-lookup"><span data-stu-id="a4620-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances to deploy a two-tier environment that meets the following requirements:</span></span>

* <span data-ttu-id="a4620-106">Webtoepassing moet toegankelijk zijn via openbaar Internet.</span><span class="sxs-lookup"><span data-stu-id="a4620-106">Web application must be accessible from the public Internet only.</span></span>
* <span data-ttu-id="a4620-107">Webserver die als host fungeert voor de toepassing moet toegang hebben tot de server van een back-end-toepassing.</span><span class="sxs-lookup"><span data-stu-id="a4620-107">Web server hosting the application must be able to access a backend application server.</span></span>
* <span data-ttu-id="a4620-108">Al het verkeer van Internet naar de webtoepassing moet via een virtueel firewallapparaat gaan.</span><span class="sxs-lookup"><span data-stu-id="a4620-108">All traffic from the Internet to the web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="a4620-109">Deze virtueel apparaat wordt gebruikt voor Internet-verkeer.</span><span class="sxs-lookup"><span data-stu-id="a4620-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="a4620-110">Alle verkeer wordt doorgestuurd naar de toepassingsserver moet gaan via een firewall virtueel apparaat.</span><span class="sxs-lookup"><span data-stu-id="a4620-110">All traffic going to the application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="a4620-111">Deze virtueel apparaat wordt gebruikt voor toegang tot de back-endserver, en afkomstig uit de on-premises netwerk via een VPN-Gateway.</span><span class="sxs-lookup"><span data-stu-id="a4620-111">This virtual appliance will be used for access to the backend end server, and access coming in from the on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="a4620-112">Beheerders moeten kunnen de firewall virtuele apparaten van hun lokale computers beheren, met behulp van een derde firewall virtueel apparaat gebruikt uitsluitend voor beheerdoeleinden.</span><span class="sxs-lookup"><span data-stu-id="a4620-112">Administrators must be able to manage the firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="a4620-113">Dit is een standaard DMZ scenario met een Perimeternetwerk en een beveiligd netwerk.</span><span class="sxs-lookup"><span data-stu-id="a4620-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="a4620-114">Dergelijke scenario kan worden gemaakt in Azure met nsg's, firewall virtuele apparaten of een combinatie van beide.</span><span class="sxs-lookup"><span data-stu-id="a4620-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="a4620-115">De onderstaande tabel bevat enkele van de voor- en nadelen tussen nsg's en virtuele firewallapparaten.</span><span class="sxs-lookup"><span data-stu-id="a4620-115">The table below shows some of the pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="a4620-116">Professionals</span><span class="sxs-lookup"><span data-stu-id="a4620-116">Pros</span></span> | <span data-ttu-id="a4620-117">Nadelen</span><span class="sxs-lookup"><span data-stu-id="a4620-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a4620-118">NSG</span><span class="sxs-lookup"><span data-stu-id="a4620-118">NSG</span></span> |<span data-ttu-id="a4620-119">Er zijn geen kosten.</span><span class="sxs-lookup"><span data-stu-id="a4620-119">No cost.</span></span> <br/><span data-ttu-id="a4620-120">Geïntegreerd in Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="a4620-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="a4620-121">Regels kunnen worden gemaakt in ARM-sjablonen.</span><span class="sxs-lookup"><span data-stu-id="a4620-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="a4620-122">Complexiteit kan variëren in grotere omgevingen.</span><span class="sxs-lookup"><span data-stu-id="a4620-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="a4620-123">Firewall</span><span class="sxs-lookup"><span data-stu-id="a4620-123">Firewall</span></span> |<span data-ttu-id="a4620-124">Volledige controle over vlak van gegevens.</span><span class="sxs-lookup"><span data-stu-id="a4620-124">Full control over data plane.</span></span> <br/><span data-ttu-id="a4620-125">Centraal beheer via de firewall-console.</span><span class="sxs-lookup"><span data-stu-id="a4620-125">Central management through firewall console.</span></span> |<span data-ttu-id="a4620-126">Kosten van de firewall-apparaat.</span><span class="sxs-lookup"><span data-stu-id="a4620-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="a4620-127">Niet geïntegreerd met Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="a4620-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="a4620-128">De onderstaande oplossing maakt gebruik van virtuele firewallapparaten voor het implementeren van een netwerk DMZ/beveiligde scenario.</span><span class="sxs-lookup"><span data-stu-id="a4620-128">The solution below uses firewall virtual appliances to implement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="a4620-129">Overwegingen</span><span class="sxs-lookup"><span data-stu-id="a4620-129">Considerations</span></span>
<span data-ttu-id="a4620-130">U kunt de omgeving die hierboven worden uitgelegd in Azure met behulp van verschillende functies die beschikbaar zijn vandaag, als volgt implementeren.</span><span class="sxs-lookup"><span data-stu-id="a4620-130">You can deploy the environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="a4620-131">**Virtueel netwerk (VNet)**.</span><span class="sxs-lookup"><span data-stu-id="a4620-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="a4620-132">Een Azure VNet fungeert in dezelfde manier als een on-premises netwerk en kunnen worden gesegmenteerd in een of meer subnetten voor isolatie van verkeer en scheiding van problemen.</span><span class="sxs-lookup"><span data-stu-id="a4620-132">An Azure VNet acts in similar fashion to an on-premises network, and can be segmented into one or more subnets to provide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="a4620-133">**Virtueel apparaat**.</span><span class="sxs-lookup"><span data-stu-id="a4620-133">**Virtual appliance**.</span></span> <span data-ttu-id="a4620-134">Diverse partners bieden virtuele apparaten in Azure Marketplace die kunnen worden gebruikt voor de drie firewalls die hierboven worden beschreven.</span><span class="sxs-lookup"><span data-stu-id="a4620-134">Several partners provide virtual appliances in the Azure Marketplace that can be used for the three firewalls described above.</span></span> 
* <span data-ttu-id="a4620-135">**De gebruiker gedefinieerde Routes (UDR)**.</span><span class="sxs-lookup"><span data-stu-id="a4620-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="a4620-136">Routetabellen kunnen udr's die worden gebruikt door Azure netwerken voor het beheren van de stroom van pakketten binnen een VNet bevatten.</span><span class="sxs-lookup"><span data-stu-id="a4620-136">Route tables can contain UDRs used by Azure networking to control the flow of packets within a VNet.</span></span> <span data-ttu-id="a4620-137">Deze routetabellen kunnen worden toegepast op subnetten.</span><span class="sxs-lookup"><span data-stu-id="a4620-137">These route tables can be applied to subnets.</span></span> <span data-ttu-id="a4620-138">Een van de nieuwste functies in Azure is de mogelijkheid een routetabel toepassen op het GatewaySubnet, bieden de mogelijkheid voor het doorsturen van alle verkeer dat afkomstig van een hybride verbinding is in de Azure-VNet naar een virtueel apparaat.</span><span class="sxs-lookup"><span data-stu-id="a4620-138">One of the newest features in Azure is the ability to apply a route table to the GatewaySubnet, providing the ability to forward all traffic coming into the Azure VNet from a hybrid connection to a virtual appliance.</span></span>
* <span data-ttu-id="a4620-139">**Doorsturen via IP**.</span><span class="sxs-lookup"><span data-stu-id="a4620-139">**IP Forwarding**.</span></span> <span data-ttu-id="a4620-140">Standaard de Azure VPN-engine doorsturen van pakketten naar virtuele netwerkinterfacekaarten (NIC's) alleen als het pakket doel-IP-adres overeenkomt met de NIC IP-adres.</span><span class="sxs-lookup"><span data-stu-id="a4620-140">By default, the Azure networking engine forward packets to virtual network interface cards (NICs) only if the packet destination IP address matches the NIC IP address.</span></span> <span data-ttu-id="a4620-141">Als een UDR gedefinieerd dat een pakket naar een bepaald virtueel apparaat moet worden verzonden, zou de Azure VPN-engine daarom dat pakket verwijderen.</span><span class="sxs-lookup"><span data-stu-id="a4620-141">Therefore, if a UDR defines that a packet must be sent to a given virtual appliance, the Azure networking engine would drop that packet.</span></span> <span data-ttu-id="a4620-142">Om te controleren of dat het pakket aan een virtuele machine (in dit geval een virtueel apparaat) dat niet het werkelijke doel voor het pakket wordt geleverd, moet u doorsturen via IP inschakelen voor het virtuele apparaat.</span><span class="sxs-lookup"><span data-stu-id="a4620-142">To ensure the packet is delivered to a VM (in this case a virtual appliance) that is not the actual destination for the packet, you need to enable IP Forwarding for the virtual appliance.</span></span>
* <span data-ttu-id="a4620-143">**Netwerkbeveiligingsgroepen (nsg's)**.</span><span class="sxs-lookup"><span data-stu-id="a4620-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="a4620-144">Het volgende voorbeeld maakt geen gebruik van het nsg's, maar u kunt nsg's die worden toegepast op de subnetten en/of NIC's in deze oplossing gebruiken als het verkeer van en naar deze subnetten en NIC's verder te filteren.</span><span class="sxs-lookup"><span data-stu-id="a4620-144">The example below does not make use of NSGs, but you could use NSGs applied to the subnets and/or NICs in this solution to further filter the traffic in and out of those subnets and NICs.</span></span>

![IPv6-connectiviteit](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="a4620-146">In dit voorbeeld is er een abonnement dat het volgende bevat:</span><span class="sxs-lookup"><span data-stu-id="a4620-146">In this example there is a subscription that contains the following:</span></span>

* <span data-ttu-id="a4620-147">2 resourcegroepen, niet weergegeven in het diagram.</span><span class="sxs-lookup"><span data-stu-id="a4620-147">2 resource groups, not shown in the diagram.</span></span> 
  * <span data-ttu-id="a4620-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="a4620-148">**ONPREMRG**.</span></span> <span data-ttu-id="a4620-149">Bevat alle resources die nodig zijn om te simuleren van een on-premises netwerk.</span><span class="sxs-lookup"><span data-stu-id="a4620-149">Contains all resources necessary to simulate an on-premises network.</span></span>
  * <span data-ttu-id="a4620-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="a4620-150">**AZURERG**.</span></span> <span data-ttu-id="a4620-151">Bevat alle resources die nodig zijn voor de Azure virtual network-omgeving.</span><span class="sxs-lookup"><span data-stu-id="a4620-151">Contains all resources necessary for the Azure virtual network environment.</span></span> 
* <span data-ttu-id="a4620-152">Een VNet met de naam **onpremvnet** gebruikt om na te bootsen van een on-premises datacentrum gesegmenteerde zoals hieronder weergegeven.</span><span class="sxs-lookup"><span data-stu-id="a4620-152">A VNet named **onpremvnet** used to mimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="a4620-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="a4620-153">**onpremsn1**.</span></span> <span data-ttu-id="a4620-154">Subnet met een virtuele machine (VM) Ubuntu na te bootsen van een on-premises server wordt uitgevoerd.</span><span class="sxs-lookup"><span data-stu-id="a4620-154">Subnet containing a virtual machine (VM) running Ubuntu to mimic an on-premises server.</span></span>
  * <span data-ttu-id="a4620-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="a4620-155">**onpremsn2**.</span></span> <span data-ttu-id="a4620-156">Subnet met een virtuele machine Ubuntu na te bootsen van een on-premises-computer die wordt gebruikt door een beheerder uitgevoerd.</span><span class="sxs-lookup"><span data-stu-id="a4620-156">Subnet containing a VM running Ubuntu to mimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="a4620-157">Er is een firewall virtueel apparaat met de naam **OPFW** op **onpremvnet** gebruikt voor het onderhouden van een tunnel naar **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="a4620-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used to maintain a tunnel to **azurevnet**.</span></span>
* <span data-ttu-id="a4620-158">Een VNet met de naam **azurevnet** gesegmenteerde zoals hieronder weergegeven.</span><span class="sxs-lookup"><span data-stu-id="a4620-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="a4620-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="a4620-159">**azsn1**.</span></span> <span data-ttu-id="a4620-160">Externe firewall subnet uitsluitend gebruikt voor de externe firewall.</span><span class="sxs-lookup"><span data-stu-id="a4620-160">External firewall subnet used exclusively for the external firewall.</span></span> <span data-ttu-id="a4620-161">Al het internetverkeer wordt geleverd in via dit subnet.</span><span class="sxs-lookup"><span data-stu-id="a4620-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="a4620-162">Dit subnet bevat alleen een NIC die is gekoppeld aan de externe firewall.</span><span class="sxs-lookup"><span data-stu-id="a4620-162">This subnet only contains a NIC linked to the external firewall.</span></span>
  * <span data-ttu-id="a4620-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="a4620-163">**azsn2**.</span></span> <span data-ttu-id="a4620-164">Front-end-subnet die als host fungeert voor een virtuele machine wordt uitgevoerd als een webserver die kan worden bereikt vanaf het Internet.</span><span class="sxs-lookup"><span data-stu-id="a4620-164">Front end subnet hosting a VM running as a web server that will be accessed from the Internet.</span></span>
  * <span data-ttu-id="a4620-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="a4620-165">**azsn3**.</span></span> <span data-ttu-id="a4620-166">Back-end subnet die als host fungeert voor een virtuele machine een back-end-toepassingsserver die wordt geopend door de front-end-webserver uitgevoerd.</span><span class="sxs-lookup"><span data-stu-id="a4620-166">Backend subnet hosting a VM running a backend application server that will be accessed by the front end web server.</span></span>
  * <span data-ttu-id="a4620-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="a4620-167">**azsn4**.</span></span> <span data-ttu-id="a4620-168">Management-subnet worden uitsluitend gebruikt voor beheer van toegang tot alle firewall virtuele apparaten.</span><span class="sxs-lookup"><span data-stu-id="a4620-168">Management subnet used exclusively to provide management access to all firewall virtual appliances.</span></span> <span data-ttu-id="a4620-169">Dit subnet bevat alleen een NIC voor elke firewall virtueel apparaat gebruikt voor de oplossing.</span><span class="sxs-lookup"><span data-stu-id="a4620-169">This subnet only contains a NIC for each firewall virtual appliance used in the solution.</span></span>
  * <span data-ttu-id="a4620-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="a4620-170">**GatewaySubnet**.</span></span> <span data-ttu-id="a4620-171">Azure hybride verbinding subnet vereist voor de ExpressRoute- en VPN-Gateway voor een verbinding tussen Azure VNets en andere netwerken.</span><span class="sxs-lookup"><span data-stu-id="a4620-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway to provide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="a4620-172">Er zijn 3 firewall virtuele apparaten in de **azurevnet** netwerk.</span><span class="sxs-lookup"><span data-stu-id="a4620-172">There are 3 firewall virtual appliances in the **azurevnet** network.</span></span> 
  * <span data-ttu-id="a4620-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="a4620-173">**AZF1**.</span></span> <span data-ttu-id="a4620-174">Externe firewall blootgesteld aan het openbare Internet met behulp van een openbare IP-adres resource in Azure.</span><span class="sxs-lookup"><span data-stu-id="a4620-174">External firewall exposed to the public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="a4620-175">U moet zorg ervoor dat u hebt een sjabloon uit de Marketplace of rechtstreeks uit de leverancier van uw apparaat, dat voorziet in een virtueel apparaat 3-NIC.</span><span class="sxs-lookup"><span data-stu-id="a4620-175">You need to ensure you have a template from the Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="a4620-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="a4620-176">**AZF2**.</span></span> <span data-ttu-id="a4620-177">Interne firewall gebruikt voor het beheren van verkeer tussen **azsn2** en **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="a4620-177">Internal firewall used to control traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="a4620-178">Dit is ook een 3-NIC virtueel apparaat.</span><span class="sxs-lookup"><span data-stu-id="a4620-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="a4620-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="a4620-179">**AZF3**.</span></span> <span data-ttu-id="a4620-180">Beheer van firewall toegankelijk voor beheerders van de on-premises datacentrum en is verbonden met een management subnet dat wordt gebruikt voor het beheren van alle firewallapparaten.</span><span class="sxs-lookup"><span data-stu-id="a4620-180">Management firewall accessible to administrators from the on-premises datacenter, and connected to a management subnet used to manage all firewall appliances.</span></span> <span data-ttu-id="a4620-181">U kunt 2-NIC sjablonen voor virtueel apparaat vinden in de Marketplace of vraag een rechtstreeks van de leverancier van uw apparaat.</span><span class="sxs-lookup"><span data-stu-id="a4620-181">You can find 2-NIC virtual appliance templates in the Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="a4620-182">Door de gebruiker gedefinieerde Routering</span><span class="sxs-lookup"><span data-stu-id="a4620-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="a4620-183">Elk subnet in Azure kan worden gekoppeld aan een tabel UDR is gebruikt om te definiëren hoe verkeer wordt gestart in dat subnet wordt doorgestuurd.</span><span class="sxs-lookup"><span data-stu-id="a4620-183">Each subnet in Azure can be linked to a UDR table used to define how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="a4620-184">Als er geen udr's zijn gedefinieerd, Azure standaardroutes gebruikt om verkeer van één subnet naar andere stromen te staan.</span><span class="sxs-lookup"><span data-stu-id="a4620-184">If no UDRs are defined, Azure uses default routes to allow traffic to flow from one subnet to another.</span></span> <span data-ttu-id="a4620-185">Voor een beter begrip udr's, gaat u naar [wat de gebruiker gedefinieerde Routes en doorsturen via IP zijn](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="a4620-185">To better understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="a4620-186">Om ervoor te zorgen communicatie vindt plaats via de juiste firewallapparaat op basis van de laatste vereiste hierboven, moet u de volgende routetabel met udr's in maken **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="a4620-186">To ensure communication is done through the right firewall appliance, based on the last requirement above, you need to create the following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="a4620-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="a4620-187">azgwudr</span></span>
<span data-ttu-id="a4620-188">In dit scenario wordt alleen verkeer stroomt van on-premises naar Azure wordt gebruikt voor het beheren van de firewalls door verbinding te maken **AZF3**, en dat verkeer via de interne firewall moet gaan **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="a4620-188">In this scenario, the only traffic flowing from on-premises to Azure will be used to manage the firewalls by connecting to **AZF3**, and that traffic must go through the internal firewall, **AZF2**.</span></span> <span data-ttu-id="a4620-189">Slechts één route is daarom nodig in de **GatewaySubnet** zoals hieronder wordt weergegeven.</span><span class="sxs-lookup"><span data-stu-id="a4620-189">Therefore, only one route is necessary in the **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="a4620-190">Doel</span><span class="sxs-lookup"><span data-stu-id="a4620-190">Destination</span></span> | <span data-ttu-id="a4620-191">Volgende hop</span><span class="sxs-lookup"><span data-stu-id="a4620-191">Next hop</span></span> | <span data-ttu-id="a4620-192">Uitleg</span><span class="sxs-lookup"><span data-stu-id="a4620-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a4620-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="a4620-193">10.0.4.0/24</span></span> |<span data-ttu-id="a4620-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="a4620-194">10.0.3.11</span></span> |<span data-ttu-id="a4620-195">Lokale gegevensverkeer te bereiken management firewall **AZF3**</span><span class="sxs-lookup"><span data-stu-id="a4620-195">Allows on-premises traffic to reach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="a4620-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="a4620-196">azsn2udr</span></span>
| <span data-ttu-id="a4620-197">Doel</span><span class="sxs-lookup"><span data-stu-id="a4620-197">Destination</span></span> | <span data-ttu-id="a4620-198">Volgende hop</span><span class="sxs-lookup"><span data-stu-id="a4620-198">Next hop</span></span> | <span data-ttu-id="a4620-199">Uitleg</span><span class="sxs-lookup"><span data-stu-id="a4620-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a4620-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="a4620-200">10.0.3.0/24</span></span> |<span data-ttu-id="a4620-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="a4620-201">10.0.2.11</span></span> |<span data-ttu-id="a4620-202">Staat toe dat verkeer het back-end-subnet voor het hosten van de toepassingsserver via **AZF2**</span><span class="sxs-lookup"><span data-stu-id="a4620-202">Allows traffic to the backend subnet hosting the application server through **AZF2**</span></span> |
| <span data-ttu-id="a4620-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="a4620-203">0.0.0.0/0</span></span> |<span data-ttu-id="a4620-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="a4620-204">10.0.2.10</span></span> |<span data-ttu-id="a4620-205">Hiermee kunt u al het andere verkeer te routeren via **AZF1**</span><span class="sxs-lookup"><span data-stu-id="a4620-205">Allows all other traffic to be routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="a4620-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="a4620-206">azsn3udr</span></span>
| <span data-ttu-id="a4620-207">Doel</span><span class="sxs-lookup"><span data-stu-id="a4620-207">Destination</span></span> | <span data-ttu-id="a4620-208">Volgende hop</span><span class="sxs-lookup"><span data-stu-id="a4620-208">Next hop</span></span> | <span data-ttu-id="a4620-209">Uitleg</span><span class="sxs-lookup"><span data-stu-id="a4620-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a4620-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="a4620-210">10.0.2.0/24</span></span> |<span data-ttu-id="a4620-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="a4620-211">10.0.3.10</span></span> |<span data-ttu-id="a4620-212">Staat toe dat verkeer **azsn2** naar de stroom van appserver naar de webserver via **AZF2**</span><span class="sxs-lookup"><span data-stu-id="a4620-212">Allows traffic to **azsn2** to flow from app server to the webserver through **AZF2**</span></span> |

<span data-ttu-id="a4620-213">U moet ook routetabellen van de subnetten in maken **onpremvnet** na te bootsen van de on-premises datacentrum.</span><span class="sxs-lookup"><span data-stu-id="a4620-213">You also need to create route tables for the subnets in **onpremvnet** to mimic the on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="a4620-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="a4620-214">onpremsn1udr</span></span>
| <span data-ttu-id="a4620-215">Doel</span><span class="sxs-lookup"><span data-stu-id="a4620-215">Destination</span></span> | <span data-ttu-id="a4620-216">Volgende hop</span><span class="sxs-lookup"><span data-stu-id="a4620-216">Next hop</span></span> | <span data-ttu-id="a4620-217">Uitleg</span><span class="sxs-lookup"><span data-stu-id="a4620-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a4620-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="a4620-218">192.168.2.0/24</span></span> |<span data-ttu-id="a4620-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="a4620-219">192.168.1.4</span></span> |<span data-ttu-id="a4620-220">Staat toe dat verkeer **onpremsn2** via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="a4620-220">Allows traffic to **onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="a4620-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="a4620-221">onpremsn2udr</span></span>
| <span data-ttu-id="a4620-222">Doel</span><span class="sxs-lookup"><span data-stu-id="a4620-222">Destination</span></span> | <span data-ttu-id="a4620-223">Volgende hop</span><span class="sxs-lookup"><span data-stu-id="a4620-223">Next hop</span></span> | <span data-ttu-id="a4620-224">Uitleg</span><span class="sxs-lookup"><span data-stu-id="a4620-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a4620-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="a4620-225">10.0.3.0/24</span></span> |<span data-ttu-id="a4620-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="a4620-226">192.168.2.4</span></span> |<span data-ttu-id="a4620-227">Hiermee kunt u verkeer naar de back-subnet in Azure maakt via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="a4620-227">Allows traffic to the backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="a4620-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="a4620-228">192.168.1.0/24</span></span> |<span data-ttu-id="a4620-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="a4620-229">192.168.2.4</span></span> |<span data-ttu-id="a4620-230">Staat toe dat verkeer **onpremsn1** via **OPFW**</span><span class="sxs-lookup"><span data-stu-id="a4620-230">Allows traffic to **onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="a4620-231">Doorsturen via IP</span><span class="sxs-lookup"><span data-stu-id="a4620-231">IP Forwarding</span></span>
<span data-ttu-id="a4620-232">UDR en doorsturen via IP zijn functies die u kunt gebruiken in combinatie waarmee virtuele apparaten moeten worden gebruikt voor het beheren van netwerkverkeer in een Azure VNet.</span><span class="sxs-lookup"><span data-stu-id="a4620-232">UDR and IP Forwarding are features that you can use in combination to allow virtual appliances to be used to control traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="a4620-233">Een virtueel apparaat is niets meer dan een virtuele machine waarop een toepassing wordt uitgevoerd om netwerkverkeer op een bepaalde manier af te handelen, zoals een firewall of een NAT-apparaat.</span><span class="sxs-lookup"><span data-stu-id="a4620-233">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="a4620-234">Deze VM op het virtuele apparaat moet in staat zijn om binnenkomend verkeer te ontvangen dat niet is geadresseerd aan zichzelf.</span><span class="sxs-lookup"><span data-stu-id="a4620-234">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="a4620-235">Om met een VM verkeer te kunnen ontvangen dat is geadresseerd aan andere bestemmingen, moet u Doorsturen via IP inschakelen voor die VM.</span><span class="sxs-lookup"><span data-stu-id="a4620-235">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="a4620-236">Dit is een Azure-instelling, niet een instelling in het gastbesturingssysteem.</span><span class="sxs-lookup"><span data-stu-id="a4620-236">This is an Azure setting, not a setting in the guest operating system.</span></span> <span data-ttu-id="a4620-237">Uw virtuele apparaat moet nog steeds worden uitgevoerd van een type van de toepassing de binnenkomend verkeer verwerken en deze op de juiste wijze te routeren.</span><span class="sxs-lookup"><span data-stu-id="a4620-237">Your virtual appliance still needs to run some type of application to handle the incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="a4620-238">Voor meer informatie over het doorsturen via IP, gaat u naar [wat de gebruiker gedefinieerde Routes en doorsturen via IP zijn](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="a4620-238">To learn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="a4620-239">Stel, dat u hebt de volgende instellingen in een Azure vnet bijvoorbeeld:</span><span class="sxs-lookup"><span data-stu-id="a4620-239">As an example, imagine you have the following setup in an Azure vnet:</span></span>

* <span data-ttu-id="a4620-240">Subnet **onpremsn1** bevat een virtuele machine met de naam **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="a4620-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="a4620-241">Subnet **onpremsn2** bevat een virtuele machine met de naam **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="a4620-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="a4620-242">Een virtueel apparaat met de naam **OPFW** is verbonden met **onpremsn1** en **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="a4620-242">A virtual appliance named **OPFW** is connected to **onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="a4620-243">Een door de gebruiker gedefinieerde route gekoppeld aan **onpremsn1** geeft aan dat alle verkeer naar **onpremsn2** moet worden verzonden naar **OPFW**.</span><span class="sxs-lookup"><span data-stu-id="a4620-243">A user defined route linked to **onpremsn1** specifies that all traffic to **onpremsn2** must be sent to **OPFW**.</span></span>

<span data-ttu-id="a4620-244">Op dit punt, als **onpremvm1** probeert een verbinding maken met **onpremvm2**, de UDR wordt gebruikt en dat verkeer wordt verzonden naar **OPFW** als de volgende hop.</span><span class="sxs-lookup"><span data-stu-id="a4620-244">At this point, if **onpremvm1** tries to establish a connection with **onpremvm2**, the UDR will be used and traffic will be sent to **OPFW** as the next hop.</span></span> <span data-ttu-id="a4620-245">Houd er rekening mee dat het doel van de daadwerkelijke pakket niet wordt gewijzigd, wordt nog steeds aangegeven **onpremvm2** is de bestemming.</span><span class="sxs-lookup"><span data-stu-id="a4620-245">Keep in mind that the actual packet destination is not being changed, it still says **onpremvm2** is the destination.</span></span> 

<span data-ttu-id="a4620-246">Zonder de IP-doorsturen is ingeschakeld voor **OPFW**, de Azure virtuele netwerken logica wordt de pakketten verwijderen omdat deze alleen kan pakketten worden verzonden naar een virtuele machine als de VM IP-adres het doel voor het pakket is.</span><span class="sxs-lookup"><span data-stu-id="a4620-246">Without IP Forwarding enabled for **OPFW**, the Azure virtual networking logic will drop the packets, since it only allows packets to be sent to a VM if the VM’s IP address is the destination for the packet.</span></span>

<span data-ttu-id="a4620-247">Met het doorsturen via IP stuurt de logica van de virtuele Azure-netwerk de pakketten naar OPFW, zonder dat u de oorspronkelijke doeladres wijzigt.</span><span class="sxs-lookup"><span data-stu-id="a4620-247">With IP Forwarding, the Azure virtual network logic will forward the packets to OPFW, without changing its original destination address.</span></span> <span data-ttu-id="a4620-248">**OPFW** moet verwerken van de pakketten en bepalen wat te doen met deze.</span><span class="sxs-lookup"><span data-stu-id="a4620-248">**OPFW** must handle the packets and determine what to do with them.</span></span>

<span data-ttu-id="a4620-249">Voor het bovenstaande scenario om te werken, moet u inschakelen op de NIC's voor doorsturen via IP **OPFW**, **AZF1**, **AZF2**, en **AZF3** die worden gebruikt voor het doorsturen van (alle NIC's, behalve die is gekoppeld aan het subnet management).</span><span class="sxs-lookup"><span data-stu-id="a4620-249">For the scenario above to work, you must enable IP Forwarding on the NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except the ones linked to the management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="a4620-250">Firewallregels</span><span class="sxs-lookup"><span data-stu-id="a4620-250">Firewall Rules</span></span>
<span data-ttu-id="a4620-251">Zoals hierboven wordt beschreven, doorsturen via IP alleen zorgt ervoor dat pakketten worden verzonden naar de virtuele apparaten.</span><span class="sxs-lookup"><span data-stu-id="a4620-251">As described above, IP Forwarding only ensures packets are sent to the virtual appliances.</span></span> <span data-ttu-id="a4620-252">Uw apparaat moet nog steeds bepalen wat te doen met de pakketten.</span><span class="sxs-lookup"><span data-stu-id="a4620-252">Your appliance still needs to decide what to do with those packets.</span></span> <span data-ttu-id="a4620-253">In het scenario moet u de volgende regels maken in uw apparaten:</span><span class="sxs-lookup"><span data-stu-id="a4620-253">In the scenario above, you will need to create the following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="a4620-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="a4620-254">OPFW</span></span>
<span data-ttu-id="a4620-255">OPFW vertegenwoordigt een on-premises-apparaat met de volgende regels:</span><span class="sxs-lookup"><span data-stu-id="a4620-255">OPFW represents an on-premises device containing the following rules:</span></span>

* <span data-ttu-id="a4620-256">**Route**: alle verkeer naar 10.0.0.0/16 (**azurevnet**) moet worden verzonden via de tunnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="a4620-256">**Route**: All traffic to 10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="a4620-257">**Beleid**: alle bidirectionele verkeer tussen **port2** en **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="a4620-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="a4620-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="a4620-258">AZF1</span></span>
<span data-ttu-id="a4620-259">AZF1 vertegenwoordigt een Azure virtueel apparaat met de volgende regels:</span><span class="sxs-lookup"><span data-stu-id="a4620-259">AZF1 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="a4620-260">**Beleid**: alle bidirectionele verkeer tussen **port1** en **port2**.</span><span class="sxs-lookup"><span data-stu-id="a4620-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="a4620-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="a4620-261">AZF2</span></span>
<span data-ttu-id="a4620-262">AZF2 vertegenwoordigt een Azure virtueel apparaat met de volgende regels:</span><span class="sxs-lookup"><span data-stu-id="a4620-262">AZF2 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="a4620-263">**Route**: alle verkeer naar 10.0.0.0/16 (**onpremvnet**) moet worden verzonden naar de Azure-gateway IP-adres (dat wil zeggen 10.0.0.1) via **port1**.</span><span class="sxs-lookup"><span data-stu-id="a4620-263">**Route**: All traffic to 10.0.0.0/16 (**onpremvnet**) must be sent to the Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="a4620-264">**Beleid**: alle bidirectionele verkeer tussen **port1** en **port2**.</span><span class="sxs-lookup"><span data-stu-id="a4620-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="a4620-265">Netwerkbeveiligingsgroepen (nsg's)</span><span class="sxs-lookup"><span data-stu-id="a4620-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="a4620-266">Nsg's worden in dit scenario wordt niet gebruikt.</span><span class="sxs-lookup"><span data-stu-id="a4620-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="a4620-267">U kunt echter nsg's toepassen aan elk subnet moet het inkomende en uitgaande verkeer te beperken.</span><span class="sxs-lookup"><span data-stu-id="a4620-267">However, you could apply NSGs to each subnet to restrict incoming and outgoing traffic.</span></span> <span data-ttu-id="a4620-268">U kan bijvoorbeeld de volgende NSG-regels toepassen op het externe FW subnet.</span><span class="sxs-lookup"><span data-stu-id="a4620-268">For instance, you could apply the following NSG rules to the external FW subnet.</span></span>

<span data-ttu-id="a4620-269">**Binnenkomende**</span><span class="sxs-lookup"><span data-stu-id="a4620-269">**Incoming**</span></span>

* <span data-ttu-id="a4620-270">Alle TCP-verkeer op poort 80 op elke virtuele machine in het subnet vanaf het Internet toestaan.</span><span class="sxs-lookup"><span data-stu-id="a4620-270">Allow all TCP traffic from the Internet to port 80 on any VM in the subnet.</span></span>
* <span data-ttu-id="a4620-271">Al het andere verkeer vanaf Internet weigeren.</span><span class="sxs-lookup"><span data-stu-id="a4620-271">Deny all other traffic from the Internet.</span></span>

<span data-ttu-id="a4620-272">**Uitgaande**</span><span class="sxs-lookup"><span data-stu-id="a4620-272">**Outgoing**</span></span>

* <span data-ttu-id="a4620-273">Al het verkeer naar Internet weigeren.</span><span class="sxs-lookup"><span data-stu-id="a4620-273">Deny all traffic to the Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="a4620-274">Hoog niveau stappen</span><span class="sxs-lookup"><span data-stu-id="a4620-274">High level steps</span></span>
<span data-ttu-id="a4620-275">Volg de onderstaande stappen hoog niveau voor het implementeren van dit scenario.</span><span class="sxs-lookup"><span data-stu-id="a4620-275">To deploy this scenario, follow the high level steps below.</span></span>

1. <span data-ttu-id="a4620-276">Meld u aan met uw Azure-abonnement.</span><span class="sxs-lookup"><span data-stu-id="a4620-276">Login to your Azure Subscription.</span></span>
2. <span data-ttu-id="a4620-277">Als u implementeren van een VNet om na te bootsen van de on-premises netwerk wilt, de resources die deel van uitmaken inrichten **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="a4620-277">If you want to deploy a VNet to mimic the on-premises network, provision the resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="a4620-278">De resources die deel van uitmaken inrichten **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="a4620-278">Provision the resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="a4620-279">Inrichten van de tunnel van **onpremvnet** naar **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="a4620-279">Provision the tunnel from **onpremvnet** to **azurevnet**.</span></span>
5. <span data-ttu-id="a4620-280">Zodra alle resources zijn ingericht, meld u aan bij **onpremvm2** en ping 10.0.3.101 connectiviteit tussen testen **onpremsn2** en **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="a4620-280">Once all resources are provisioned, log on to **onpremvm2** and ping 10.0.3.101 to test connectivity between **onpremsn2** and **azsn3**.</span></span>

