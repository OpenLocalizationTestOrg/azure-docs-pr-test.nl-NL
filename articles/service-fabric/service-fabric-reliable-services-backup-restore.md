---
title: Service Fabric Backup and Restore | Microsoft Docs
description: Conceptuele documentatie voor Service Fabric-back-up en herstel
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: 4242962e7e03053ef25f198a0b2f6c8012e693eb
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/29/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="4014b-103">Back-up en herstel Reliable Services en Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="4014b-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="4014b-104">Azure Service Fabric is een hoge beschikbaarheid-platform die de status repliceert op meerdere knooppunten om deze hoge beschikbaarheid te houden.</span><span class="sxs-lookup"><span data-stu-id="4014b-104">Azure Service Fabric is a high-availability platform that replicates the state across multiple nodes to maintain this high availability.</span></span>  <span data-ttu-id="4014b-105">Dus zelfs als een knooppunt in het cluster is mislukt, blijven de services beschikbaar.</span><span class="sxs-lookup"><span data-stu-id="4014b-105">Thus, even if one node in the cluster fails, the services continue to be available.</span></span> <span data-ttu-id="4014b-106">Bij deze ingebouwde redundantie geleverd door het platform is mogelijk niet voldoende is voor sommige, in bepaalde gevallen is het wenselijk voor de service voor back-ups (naar een externe winkel).</span><span class="sxs-lookup"><span data-stu-id="4014b-106">While this in-built redundancy provided by the platform may be sufficient for some, in certain cases it is desirable for the service to back up data (to an external store).</span></span>

> [!NOTE]
> <span data-ttu-id="4014b-107">Het is essentieel voor back-up en herstellen van uw gegevens (en test werkt zoals verwacht) zodat u vanaf gegevensverlies herstellen kunt.</span><span class="sxs-lookup"><span data-stu-id="4014b-107">It is critical to backup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="4014b-108">Een service wilt bijvoorbeeld een back-up van gegevens om te voorkomen dat de volgende scenario's:</span><span class="sxs-lookup"><span data-stu-id="4014b-108">For example, a service may want to back up data in order to protect from the following scenarios:</span></span>

- <span data-ttu-id="4014b-109">In geval van een permanent verlies van een volledige Service Fabric-cluster.</span><span class="sxs-lookup"><span data-stu-id="4014b-109">In the event of the permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="4014b-110">Permanent verlies van een meerderheid van de replica's van de partitie van een service</span><span class="sxs-lookup"><span data-stu-id="4014b-110">Permanent loss of a majority of the replicas of a service partition</span></span>
- <span data-ttu-id="4014b-111">Administratieve fouten waarbij de status per ongeluk wordt verwijderd of beschadigd.</span><span class="sxs-lookup"><span data-stu-id="4014b-111">Administrative errors whereby the state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="4014b-112">Dit kan bijvoorbeeld gebeuren als een beheerder met voldoende bevoegdheden per ongeluk worden verwijderd van de service.</span><span class="sxs-lookup"><span data-stu-id="4014b-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes the service.</span></span>
- <span data-ttu-id="4014b-113">Fouten in de service die leiden gegevensbeschadiging van tot.</span><span class="sxs-lookup"><span data-stu-id="4014b-113">Bugs in the service that cause data corruption.</span></span> <span data-ttu-id="4014b-114">Dit kan bijvoorbeeld gebeuren wanneer een code-upgrade van service wordt gestart met het schrijven van beschadigde gegevens naar een betrouwbare verzameling.</span><span class="sxs-lookup"><span data-stu-id="4014b-114">For example, this may happen when a service code upgrade starts writing faulty data to a Reliable Collection.</span></span> <span data-ttu-id="4014b-115">In dat geval zowel de code en de gegevens mogelijk teruggezet naar een eerdere status.</span><span class="sxs-lookup"><span data-stu-id="4014b-115">In such a case, both the code and the data may have to be reverted to an earlier state.</span></span>
- <span data-ttu-id="4014b-116">De gegevensverwerking is offline.</span><span class="sxs-lookup"><span data-stu-id="4014b-116">Offline data processing.</span></span> <span data-ttu-id="4014b-117">Kan het zijn handig zijn als offline verwerking van gegevens voor business intelligence die plaatsvindt afzonderlijk van de service die de gegevens genereert.</span><span class="sxs-lookup"><span data-stu-id="4014b-117">It might be convenient to have offline processing of data for business intelligence that happens separately from the service that generates the data.</span></span>

<span data-ttu-id="4014b-118">De functie back-up/herstel kan services die zijn gebaseerd op de API voor betrouwbare Services maken en herstellen van back-ups.</span><span class="sxs-lookup"><span data-stu-id="4014b-118">The Backup/Restore feature allows services built on the Reliable Services API to create and restore backups.</span></span> <span data-ttu-id="4014b-119">De back-API's die wordt geleverd door het platform toestaan backup(s) van status van een service-partitie, zonder blokkerende lees- of schrijfbewerkingen.</span><span class="sxs-lookup"><span data-stu-id="4014b-119">The backup APIs provided by the platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="4014b-120">Het terugzetten van API's maken van de partitie van een service-status moet worden teruggezet vanuit een gekozen back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-120">The restore APIs allow a service partition's state to be restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="4014b-121">Typen back-ups</span><span class="sxs-lookup"><span data-stu-id="4014b-121">Types of Backup</span></span>
<span data-ttu-id="4014b-122">Er zijn twee opties voor back-up: volledige en incrementele.</span><span class="sxs-lookup"><span data-stu-id="4014b-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="4014b-123">Een volledige back-up is een back-up waarin alle gegevens die nodig zijn om de status van de replica opnieuw te maken: controlepunten en alle records in het logboek.</span><span class="sxs-lookup"><span data-stu-id="4014b-123">A full backup is a backup that contains all the data required to recreate the state of the replica: checkpoints and all log records.</span></span>
<span data-ttu-id="4014b-124">Aangezien deze de controlepunten en het logboekbestand heeft, kan een volledige back-up kan worden hersteld door zichzelf.</span><span class="sxs-lookup"><span data-stu-id="4014b-124">Since it has the checkpoints and the log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="4014b-125">Het probleem met volledige back-ups treedt op wanneer de controlepunten groot zijn.</span><span class="sxs-lookup"><span data-stu-id="4014b-125">The problem with full backups arises when the checkpoints are large.</span></span>
<span data-ttu-id="4014b-126">Een replica met 16 GB status heeft bijvoorbeeld controlepunten die toevoegen tot ongeveer 16 GB.</span><span class="sxs-lookup"><span data-stu-id="4014b-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately to 16 GB.</span></span>
<span data-ttu-id="4014b-127">Als we een beoogd herstelpunt van vijf minuten hebt, moet de replica een back-up om de vijf minuten.</span><span class="sxs-lookup"><span data-stu-id="4014b-127">If we have a Recovery Point Objective of five minutes, the replica needs to be backed up every five minutes.</span></span>
<span data-ttu-id="4014b-128">Telkens wanneer er een back-up moet worden gekopieerd van 16 GB van controlepunten naast 50 MB (met behulp van configureerbare `CheckpointThresholdInMB`) logboeken aan.</span><span class="sxs-lookup"><span data-stu-id="4014b-128">Each time it backs up it needs to copy 16 GB of checkpoints in addition to 50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Voorbeeld van de volledige back-up.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="4014b-130">De oplossing voor dit probleem is incrementele back-ups wanneer back-up bevat alleen de gewijzigde logboekrecords sinds de laatste back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-130">The solution to this problem is incremental backups, where backup only contains the changed log records since the last backup.</span></span>

![Incrementele back-voorbeeld.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="4014b-132">Aangezien incrementele back-ups alleen wijzigingen sinds de laatste back-up (omvat geen controlepunten), ze vaak sneller zijn, maar ze kunnen niet worden teruggezet op hun eigen.</span><span class="sxs-lookup"><span data-stu-id="4014b-132">Since incremental backups are only changes since the last backup (does not include the checkpoints), they tend to be faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="4014b-133">Als u een incrementele back-up herstellen, is de volledige back-keten vereist.</span><span class="sxs-lookup"><span data-stu-id="4014b-133">To restore an incremental backup, the entire backup chain is required.</span></span>
<span data-ttu-id="4014b-134">Een back-keten is een keten van back-ups die beginnen met een volledige back-up en gevolgd door een aantal aaneengesloten incrementele back-ups.</span><span class="sxs-lookup"><span data-stu-id="4014b-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="4014b-135">Back-Reliable Services</span><span class="sxs-lookup"><span data-stu-id="4014b-135">Backup Reliable Services</span></span>
<span data-ttu-id="4014b-136">De auteur van de service heeft volledig beheer van bij het maken van back-ups en waar back-ups worden opgeslagen.</span><span class="sxs-lookup"><span data-stu-id="4014b-136">The service author has full control of when to make backups and where backups will be stored.</span></span>

<span data-ttu-id="4014b-137">Als u een back-up wilt, moet de service aanroepen van de functie overgenomen lid `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="4014b-137">To start a backup, the service needs to invoke the inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="4014b-138">Back-ups kunnen alleen vanaf de primaire replica's worden gemaakt, en ze vereisen schrijven status om te worden toegekend.</span><span class="sxs-lookup"><span data-stu-id="4014b-138">Backups can be made only from primary replicas, and they require write status to be granted.</span></span>

<span data-ttu-id="4014b-139">Zoals hieronder aangegeven, `BackupAsync` wordt in een `BackupDescription` object, een waar een volledige of incrementele back-up, evenals een callback-functie opgeven kunt, `Func<< BackupInfo, CancellationToken, Task<bool>>>` die wordt geactiveerd wanneer de back-upmap lokaal is gemaakt en gereed om te worden verplaatst is uit op sommige externe opslag.</span><span class="sxs-lookup"><span data-stu-id="4014b-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when the backup folder has been created locally and is ready to be moved out to some external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="4014b-140">Aanvraag voor het uitvoeren van een incrementele back-up mislukken met `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="4014b-140">Request to take an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="4014b-141">Deze uitzondering geeft aan dat er een van de volgende dingen gebeurt:</span><span class="sxs-lookup"><span data-stu-id="4014b-141">This exception indicates that one of the following things is happening:</span></span>

- <span data-ttu-id="4014b-142">de replica is nooit gemaakt van een volledige back-up nadat primaire geworden,</span><span class="sxs-lookup"><span data-stu-id="4014b-142">the replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="4014b-143">Sommige van de logboekrecords sinds de laatste back-up is afgekapt of</span><span class="sxs-lookup"><span data-stu-id="4014b-143">some of the log records since the last backup has been truncated or</span></span>
- <span data-ttu-id="4014b-144">replica doorgegeven de `MaxAccumulatedBackupLogSizeInMB` limiet.</span><span class="sxs-lookup"><span data-stu-id="4014b-144">replica passed the `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="4014b-145">Gebruikers kunnen vergroot de kans kunt geen incrementele back-ups configureren `MinLogSizeInMB` of `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="4014b-145">Users can increase the likelihood of being able to do incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="4014b-146">Opmerking dat uitbreiding van deze verhoogt waarden de per replica schijfgebruik.</span><span class="sxs-lookup"><span data-stu-id="4014b-146">Note that increasing these values increases the per replica disk usage.</span></span>
<span data-ttu-id="4014b-147">Zie voor meer informatie [betrouwbare configuratie van Services](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="4014b-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="4014b-148">`BackupInfo`bevat informatie over de back-up, waaronder de locatie van de map waarin de back-up in de runtime worden opgeslagen (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="4014b-148">`BackupInfo` provides information regarding the backup, including the location of the folder where the runtime saved the backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="4014b-149">De callback-functie kunt verplaatsen de `BackupInfo.Directory` naar een externe winkel of een andere locatie.</span><span class="sxs-lookup"><span data-stu-id="4014b-149">The callback function can move the `BackupInfo.Directory` to an external store or another location.</span></span>  <span data-ttu-id="4014b-150">Deze functie wordt ook een Boole-waarde die aangeeft of het kunnen de back-upmap is verplaatsen naar de doellocatie.</span><span class="sxs-lookup"><span data-stu-id="4014b-150">This function also returns a bool that indicates whether it was able to successfully move the backup folder to its target location.</span></span>

<span data-ttu-id="4014b-151">De volgende code laat zien hoe de `BackupCallbackAsync` methode kan worden gebruikt voor het uploaden van de back-up naar Azure Storage:</span><span class="sxs-lookup"><span data-stu-id="4014b-151">The following code demonstrates how the `BackupCallbackAsync` method can be used to upload the backup to Azure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="4014b-152">In het voorgaande voorbeeld `ExternalBackupStore` is de voorbeeldklasse die wordt gebruikt voor de interface met Azure Blob storage en `UploadBackupFolderAsync` is de methode die de map gecomprimeerd en plaatst het in de Azure Blob-opslag.</span><span class="sxs-lookup"><span data-stu-id="4014b-152">In the preceeding example, `ExternalBackupStore` is the sample class that is used to interface with Azure Blob storage, and `UploadBackupFolderAsync` is the method that compresses the folder and places it in the Azure Blob store.</span></span>

<span data-ttu-id="4014b-153">Opmerking:</span><span class="sxs-lookup"><span data-stu-id="4014b-153">Note that:</span></span>

  - <span data-ttu-id="4014b-154">Er mag slechts één back-upbewerking onderweg per replica op elk moment.</span><span class="sxs-lookup"><span data-stu-id="4014b-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="4014b-155">Meer dan één `BackupAsync` aanroep tegelijk genereert `FabricBackupInProgressException` inflight back-ups op een beperken.</span><span class="sxs-lookup"><span data-stu-id="4014b-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` to limit inflight backups to one.</span></span>
  - <span data-ttu-id="4014b-156">Als een replica mislukt via tijdens een back-up uitgevoerd wordt, kan de back-up niet zijn voltooid.</span><span class="sxs-lookup"><span data-stu-id="4014b-156">If a replica fails over while a backup is in progress, the backup may not have been completed.</span></span> <span data-ttu-id="4014b-157">Zodra de failover is voltooid, het is dus de verantwoordelijkheid van de service opnieuw starten van de back-up door aan te roepen `BackupAsync` indien nodig.</span><span class="sxs-lookup"><span data-stu-id="4014b-157">Thus, once the failover finishes, it is the service's responsibility to restart the backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="4014b-158">Reliable Services herstellen</span><span class="sxs-lookup"><span data-stu-id="4014b-158">Restore Reliable Services</span></span>
<span data-ttu-id="4014b-159">In het algemeen vallen de gevallen wanneer moet u mogelijk een herstelbewerking uitvoeren in een van de volgende categorieën:</span><span class="sxs-lookup"><span data-stu-id="4014b-159">In general, the cases when you might need to perform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="4014b-160">De service-partitie gegevens verloren gegaan.</span><span class="sxs-lookup"><span data-stu-id="4014b-160">The service partition lost data.</span></span> <span data-ttu-id="4014b-161">De schijf voor twee van de drie replica's voor een partitie (met inbegrip van de primaire replica) opgehaald bijvoorbeeld beschadigd of gewist.</span><span class="sxs-lookup"><span data-stu-id="4014b-161">For example, the disk for two out of three replicas for a partition (including the primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="4014b-162">De nieuwe primaire moet mogelijk gegevens terugzetten vanuit een back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-162">The new primary may need to restore data from a backup.</span></span>
  - <span data-ttu-id="4014b-163">De hele service wordt verbroken.</span><span class="sxs-lookup"><span data-stu-id="4014b-163">The entire service is lost.</span></span> <span data-ttu-id="4014b-164">Bijvoorbeeld: een beheerder verwijdert de hele service, en dus de service en de gegevens moeten worden teruggezet.</span><span class="sxs-lookup"><span data-stu-id="4014b-164">For example, an administrator removes the entire service and thus the service and the data need to be restored.</span></span>
  - <span data-ttu-id="4014b-165">De service gerepliceerd beschadigd toepassingsgegevens (bijv, vanwege een fout van toepassing).</span><span class="sxs-lookup"><span data-stu-id="4014b-165">The service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="4014b-166">In dit geval wordt de service worden bijgewerkt of hersteld voor het verwijderen van de oorzaak van de beschadiging is, en niet beschadigd gegevens moet worden hersteld.</span><span class="sxs-lookup"><span data-stu-id="4014b-166">In this case, the service has to be upgraded or reverted to remove the cause of the corruption, and non-corrupt data has to be restored.</span></span>

<span data-ttu-id="4014b-167">Hoewel veel manieren mogelijk, bieden we enkele voorbeelden voor het gebruik van `RestoreAsync` van de bovenstaande scenario's wilt herstellen.</span><span class="sxs-lookup"><span data-stu-id="4014b-167">While many approaches are possible, we offer some examples on using `RestoreAsync` to recover from the above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="4014b-168">Partitie gegevensverlies in Reliable Services</span><span class="sxs-lookup"><span data-stu-id="4014b-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="4014b-169">In dit geval de runtime automatisch wilt detecteren het verlies van gegevens en aanroepen de `OnDataLossAsync` API.</span><span class="sxs-lookup"><span data-stu-id="4014b-169">In this case, the runtime would automatically detect the data loss and invoke the `OnDataLossAsync` API.</span></span>

<span data-ttu-id="4014b-170">De auteur van de service moet uitvoeren van de volgende herstellen:</span><span class="sxs-lookup"><span data-stu-id="4014b-170">The service author needs to perform the following to recover:</span></span>

  - <span data-ttu-id="4014b-171">Negeer de methode virtuele basisklasse `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="4014b-171">Override the virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="4014b-172">De meest recente back-up niet vinden in de externe locatie waarin de back-ups van de service.</span><span class="sxs-lookup"><span data-stu-id="4014b-172">Find the latest backup in the external location that contains the service's backups.</span></span>
  - <span data-ttu-id="4014b-173">Download de meest recente back-up (en de back-up in de back-upmap decomprimeren als het is gecomprimeerd).</span><span class="sxs-lookup"><span data-stu-id="4014b-173">Download the latest backup (and uncompress the backup into the backup folder if it was compressed).</span></span>
  - <span data-ttu-id="4014b-174">De `OnDataLossAsync` methode biedt een `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="4014b-174">The `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="4014b-175">Roep de `RestoreAsync` API op de opgegeven `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="4014b-175">Call the `RestoreAsync` API on the provided `RestoreContext`.</span></span>
  - <span data-ttu-id="4014b-176">Retourneert waar als de herstelbewerking gelukt is.</span><span class="sxs-lookup"><span data-stu-id="4014b-176">Return true if the restoration was a success.</span></span>

<span data-ttu-id="4014b-177">Hieronder volgt een voorbeeld van de implementatie van de `OnDataLossAsync` methode:</span><span class="sxs-lookup"><span data-stu-id="4014b-177">Following is an example implementation of the `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="4014b-178">`RestoreDescription`de doorgegeven aan de `RestoreContext.RestoreAsync` aanroep van een lid genaamd bevat `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="4014b-178">`RestoreDescription` passed in to the `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="4014b-179">Bij het herstellen van een eenmalige volledige back-up, dit `BackupFolderPath` moet worden ingesteld op het lokale pad naar de map waarin uw volledige back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-179">When restoring a single full backup, this `BackupFolderPath` should be set to the local path of the folder that contains your full backup.</span></span>
<span data-ttu-id="4014b-180">Bij het herstellen van een volledige back-up en een aantal incrementele back-ups `BackupFolderPath` moet worden ingesteld op het lokale pad naar de map waarin niet alleen de volledige back-up, maar ook alle incrementele back-ups.</span><span class="sxs-lookup"><span data-stu-id="4014b-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set to the local path of the folder that not only contains the full backup, but also all the incremental backups.</span></span>
<span data-ttu-id="4014b-181">`RestoreAsync`aanroep kunt throw `FabricMissingFullBackupException` als de `BackupFolderPath` opgegeven bevat geen een volledige back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if the `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="4014b-182">Het kan ook de throw `ArgumentException` als `BackupFolderPath` heeft een verbroken keten van incrementele back-ups.</span><span class="sxs-lookup"><span data-stu-id="4014b-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="4014b-183">Bijvoorbeeld, als deze de volledige back-up bevat de eerste incrementele en de derde incrementele back-up, maar geen de tweede incrementele back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-183">For example, if it contains the full backup, the first incremental and the third incremental backup but no the second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="4014b-184">De RestorePolicy is standaard ingesteld op de kluis.</span><span class="sxs-lookup"><span data-stu-id="4014b-184">The RestorePolicy is set to Safe by default.</span></span>  <span data-ttu-id="4014b-185">Dit betekent dat de `RestoreAsync` API mislukt met ArgumentException als wordt gedetecteerd dat de back-upmap een status die ouder is dan of gelijk zijn aan de status van deze replica bevat.</span><span class="sxs-lookup"><span data-stu-id="4014b-185">This means that the `RestoreAsync` API will fail with ArgumentException if it detects that the backup folder contains a state that is older than or equal to the state contained in this replica.</span></span>  <span data-ttu-id="4014b-186">`RestorePolicy.Force`kan worden gebruikt om deze veiligheidscontrole overslaan.</span><span class="sxs-lookup"><span data-stu-id="4014b-186">`RestorePolicy.Force` can be used to skip this safety check.</span></span> <span data-ttu-id="4014b-187">Dit is opgegeven als onderdeel van `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="4014b-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="4014b-188">Verwijderde of verloren-service</span><span class="sxs-lookup"><span data-stu-id="4014b-188">Deleted or lost service</span></span>
<span data-ttu-id="4014b-189">Als een service wordt verwijderd, moet u eerst opnieuw maken de service voordat u de gegevens kunnen worden hersteld.</span><span class="sxs-lookup"><span data-stu-id="4014b-189">If a service is removed, you must first re-create the service before the data can be restored.</span></span>  <span data-ttu-id="4014b-190">Het is belangrijk voor het maken van de service met dezelfde configuratie, bijvoorbeeld partitieschema, zodat de gegevens naadloos kan worden hersteld.</span><span class="sxs-lookup"><span data-stu-id="4014b-190">It is important to create the service with the same configuration, e.g., partitioning scheme, so that the data can be restored seamlessly.</span></span>  <span data-ttu-id="4014b-191">Zodra de service is, de API om gegevens te herstellen (`OnDataLossAsync` hierboven) moet worden aangeroepen voor elke partitie van deze service.</span><span class="sxs-lookup"><span data-stu-id="4014b-191">Once the service is up, the API to restore data (`OnDataLossAsync` above) has to be invoked on every partition of this service.</span></span> <span data-ttu-id="4014b-192">Een manier om dat te bereiken dit is met behulp van `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` op elke partitie.</span><span class="sxs-lookup"><span data-stu-id="4014b-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="4014b-193">Vanaf dit punt is implementatie hetzelfde als het bovenstaande scenario.</span><span class="sxs-lookup"><span data-stu-id="4014b-193">From this point, implementation is the same as the above scenario.</span></span> <span data-ttu-id="4014b-194">Elke partitie moet de meest relevante back-up terugzetten vanaf de externe winkel.</span><span class="sxs-lookup"><span data-stu-id="4014b-194">Each partition needs to restore the latest relevant backup from the external store.</span></span> <span data-ttu-id="4014b-195">Een voorbehoud is dat de partitie-ID mogelijk is nu gewijzigd, omdat de runtime partitie-id dynamisch maakt.</span><span class="sxs-lookup"><span data-stu-id="4014b-195">One caveat is that the partition ID may have now changed, since the runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="4014b-196">Daarom moet de service voor het opslaan van de juiste informatie en service partitienaam voor het identificeren van de juiste meest recente back-up wilt herstellen uit voor elke partitie.</span><span class="sxs-lookup"><span data-stu-id="4014b-196">Thus, the service needs to store the appropriate partition information and service name to identify the correct latest backup to restore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="4014b-197">Het wordt niet aangeraden om te gebruiken `FabricClient.ServiceManager.InvokeDataLossAsync` op elke partitie te herstellen van de hele service, omdat dat de clusterstatus mogelijk beschadigd.</span><span class="sxs-lookup"><span data-stu-id="4014b-197">It is not recommended to use `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition to restore the entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="4014b-198">Replicatie van gegevens beschadigd toepassing</span><span class="sxs-lookup"><span data-stu-id="4014b-198">Replication of corrupt application data</span></span>
<span data-ttu-id="4014b-199">Als de upgrade van de geïmplementeerde toepassing een fout heeft, die mogelijk leiden tot beschadiging van gegevens.</span><span class="sxs-lookup"><span data-stu-id="4014b-199">If the newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="4014b-200">Een upgrade van de toepassing kan bijvoorbeeld starten record bij te werken elke telefoon nummer in een betrouwbare woordenlijst met een ongeldige netnummer.</span><span class="sxs-lookup"><span data-stu-id="4014b-200">For example, an application upgrade may start to update every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="4014b-201">In dit geval wordt de ongeldige telefoonnummers gerepliceerd sinds de Service Fabric is niet op de hoogte van de aard van de gegevens die worden opgeslagen.</span><span class="sxs-lookup"><span data-stu-id="4014b-201">In this case, the invalid phone numbers will be replicated since Service Fabric is not aware of the nature of the data that is being stored.</span></span>

<span data-ttu-id="4014b-202">Het eerste wat te doen nadat u deze een egregious fout die ervoor zorgt gegevensbeschadiging dat detecteren is het blokkeren van de service op toepassingsniveau en, indien mogelijk een upgrade uitvoert naar de versie van de toepassingscode die beschikt niet over de fout.</span><span class="sxs-lookup"><span data-stu-id="4014b-202">The first thing to do after you detect such an egregious bug that causes data corruption is to freeze the service at the application level and, if possible, upgrade to the version of the application code that does not have the bug.</span></span>  <span data-ttu-id="4014b-203">Zelfs nadat de servicecode is opgelost, de gegevens mogelijk nog steeds beschadigd en dus gegevens moeten mogelijk worden hersteld.</span><span class="sxs-lookup"><span data-stu-id="4014b-203">However, even after the service code is fixed, the data may still be corrupt and thus data may need to be restored.</span></span>  <span data-ttu-id="4014b-204">In dergelijke gevallen kan het niet toereikend zijn de meest recente back-up herstellen sinds de meest recente back-ups ook mogelijk beschadigd.</span><span class="sxs-lookup"><span data-stu-id="4014b-204">In such cases, it may not be sufficient to restore the latest backup, since the latest backups may also be corrupt.</span></span>  <span data-ttu-id="4014b-205">U moet dus vinden van de laatste back-up die is gemaakt voordat de gegevens zijn beschadigd.</span><span class="sxs-lookup"><span data-stu-id="4014b-205">Thus, you have to find the last backup that was made before the data got corrupted.</span></span>

<span data-ttu-id="4014b-206">Als u niet zeker welke back-ups zijn beschadigd weet, kan u een nieuwe Service Fabric-cluster implementeren en herstel van de back-ups van betrokken partities net als de bovenstaande 'Deleted of verloren service' scenario.</span><span class="sxs-lookup"><span data-stu-id="4014b-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore the backups of affected partitions just like the above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="4014b-207">Voor elke partitie terug te zetten van de back-ups van de meest recente minst.</span><span class="sxs-lookup"><span data-stu-id="4014b-207">For each partition, start restoring the backups from the most recent to the least.</span></span> <span data-ttu-id="4014b-208">Als u een back-up die geen beschadiging heeft gevonden, verplaatsen en verwijderen alle back-ups van deze partitie die recenter (dan back-up waren).</span><span class="sxs-lookup"><span data-stu-id="4014b-208">Once you find a backup that does not have the corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="4014b-209">Herhaal dit proces voor elke partitie.</span><span class="sxs-lookup"><span data-stu-id="4014b-209">Repeat this process for each partition.</span></span> <span data-ttu-id="4014b-210">Nu als `OnDataLossAsync` wordt aangeroepen op de partitie in de productiecluster, de laatste back-up zijn gevonden in de externe opslag zal worden verzameld door de bovenstaande procedure.</span><span class="sxs-lookup"><span data-stu-id="4014b-210">Now, when `OnDataLossAsync` is called on the partition in the production cluster, the last backup found in the external store will be the one picked by the above process.</span></span>

<span data-ttu-id="4014b-211">Nu de stappen in 'Deleted of verloren service' sectie kan worden gebruikt voor het herstellen van de status van de service op de status voordat de status van de buggy code beschadigd.</span><span class="sxs-lookup"><span data-stu-id="4014b-211">Now, the steps in the "Deleted or lost service" section can be used to restore the state of the service to the state before the buggy code corrupted the state.</span></span>

<span data-ttu-id="4014b-212">Opmerking:</span><span class="sxs-lookup"><span data-stu-id="4014b-212">Note that:</span></span>

  - <span data-ttu-id="4014b-213">Wanneer u herstelt, is er een kans is dat de back-up wordt hersteld ouder is dan de status van de partitie is voordat de gegevens verloren gegaan is.</span><span class="sxs-lookup"><span data-stu-id="4014b-213">When you restore, there is a chance that the backup being restored is older than the state of the partition before the data was lost.</span></span> <span data-ttu-id="4014b-214">Daarom moet u alleen als een laatste toevlucht herstellen zoveel mogelijk gegevens weer.</span><span class="sxs-lookup"><span data-stu-id="4014b-214">Because of this, you should restore only as a last resort to recover as much data as possible.</span></span>
  - <span data-ttu-id="4014b-215">De tekenreeks met het pad van de back-up en de paden van bestanden in de back-upmap kan niet groter zijn dan 255 tekens, afhankelijk van het pad FabricDataRoot en toepassingstype naamlengte.</span><span class="sxs-lookup"><span data-stu-id="4014b-215">The string that represents the backup folder path and the paths of files inside the backup folder can be greater than 255 characters, depending on the FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="4014b-216">Hierdoor kunnen sommige .NET-methoden zoals `Directory.Move`, om de `PathTooLongException` uitzondering.</span><span class="sxs-lookup"><span data-stu-id="4014b-216">This can cause some .NET methods, like `Directory.Move`, to throw the `PathTooLongException` exception.</span></span> <span data-ttu-id="4014b-217">Een tijdelijke oplossing is om aan te roepen rechtstreeks kan kernel32-API's, zoals `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="4014b-217">One workaround is to directly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="4014b-218">Back-up en herstel Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="4014b-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="4014b-219">Betrouwbare actoren Framework is ingebouwd in Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="4014b-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="4014b-220">De ActorService die als host fungeert voor de actor(s) is een stateful betrouwbare service.</span><span class="sxs-lookup"><span data-stu-id="4014b-220">The ActorService which hosts the actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="4014b-221">Alle back-up en herstel functionaliteit beschikbaar zijn in Reliable Services is daarom ook beschikbaar voor Reliable Actors (met uitzondering van het gedrag dat specifieke state-provider zijn).</span><span class="sxs-lookup"><span data-stu-id="4014b-221">Hence, all the backup and restore functionality available in Reliable Services is also available to Reliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="4014b-222">Sinds de back-ups zullen worden uitgevoerd op basis van de per-partitie, statussen voor alle actoren in de betreffende partitie, worden back-up (en herstel lijkt en gebeurt op basis van per partitie).</span><span class="sxs-lookup"><span data-stu-id="4014b-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="4014b-223">Als u wilt uitvoeren van back-up/herstel eigenaar van de service moet een aangepaste actor serviceklasse maken die is afgeleid van klasse ActorService en voer back-up/herstel vergelijkbaar met Reliable Services zoals hierboven is beschreven in de vorige secties.</span><span class="sxs-lookup"><span data-stu-id="4014b-223">To perform backup/restore, the service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar to Reliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="4014b-224">Wanneer u een aangepaste actor serviceklasse maakt, moet u die ook registreren bij het registreren van de actor.</span><span class="sxs-lookup"><span data-stu-id="4014b-224">When you create a custom actor service class, you need to register that as well when registering the actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="4014b-225">De standaardprovider voor de status voor Reliable Actors `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="4014b-225">The default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="4014b-226">Incrementele back-up is niet standaard ingeschakeld voor `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="4014b-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="4014b-227">U kunt de incrementele back-up inschakelen door het maken van `KvsActorStateProvider` met de juiste instelling in de constructor en deze vervolgens doorgegeven aan de constructor ActorService zoals weergegeven in het volgende codefragment:</span><span class="sxs-lookup"><span data-stu-id="4014b-227">You can enable incremental backup by creating `KvsActorStateProvider` with the appropriate setting in its constructor and then passing it to ActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="4014b-228">Nadat de incrementele back-up is ingeschakeld, duurt een incrementele back-up voor een van de volgende redenen mislukken met FabricMissingFullBackupException en moet u een volledige back-up uitvoeren voordat u incrementele backup(s):</span><span class="sxs-lookup"><span data-stu-id="4014b-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need to take a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="4014b-229">De replica is nooit een volledige back-up genomen nadat primaire werd.</span><span class="sxs-lookup"><span data-stu-id="4014b-229">The replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="4014b-230">Sommige van de records in het logboek zijn afgebroken sinds laatste back-up is gemaakt.</span><span class="sxs-lookup"><span data-stu-id="4014b-230">Some of the log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="4014b-231">Wanneer incrementele back-up is ingeschakeld, `KvsActorStateProvider` gebruikt geen circulaire buffer voor het beheren van de records in het logboek en regelmatig worden afgekapt.</span><span class="sxs-lookup"><span data-stu-id="4014b-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer to manage its log records and periodically truncates it.</span></span> <span data-ttu-id="4014b-232">Als geen back-up wordt gemaakt door gebruiker gedurende een periode van 45 minuten, wordt de logboekrecords automatisch afgekapt door het systeem.</span><span class="sxs-lookup"><span data-stu-id="4014b-232">If no backup is taken by user for a period of 45 minutes, the system automatically truncates the log records.</span></span> <span data-ttu-id="4014b-233">Dit interval kan worden geconfigureerd door op te geven `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (net als bij het inschakelen van incrementele back-up).</span><span class="sxs-lookup"><span data-stu-id="4014b-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar to when enabling incremental backup).</span></span> <span data-ttu-id="4014b-234">De logboekrecords kunnen ook ophalen afgekapt als primaire replica maken van een andere replica wilt door alle bijbehorende gegevens te verzenden.</span><span class="sxs-lookup"><span data-stu-id="4014b-234">The log records may also get truncated if primary replica need to build another replica by sending all its data.</span></span>

<span data-ttu-id="4014b-235">Bij het uitvoeren van herstel van een back-keten, vergelijkbaar met Reliable Services de BackupFolderPath moet bevatten submappen met een submap met volledige back-up en anderen die incrementele backup(s) submappen.</span><span class="sxs-lookup"><span data-stu-id="4014b-235">When doing restore from a backup chain, similar to Reliable Services, the BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="4014b-236">De API terugzetten genereert FabricException met het bijbehorende bericht als de back-up van de certificaatketen is mislukt.</span><span class="sxs-lookup"><span data-stu-id="4014b-236">The restore API will throw FabricException with appropriate error message if the backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="4014b-237">`KvsActorStateProvider`op dit moment wordt de optie RestorePolicy.Safe genegeerd.</span><span class="sxs-lookup"><span data-stu-id="4014b-237">`KvsActorStateProvider` currently ignores the option RestorePolicy.Safe.</span></span> <span data-ttu-id="4014b-238">Ondersteuning voor deze functie is in een toekomstige release gepland.</span><span class="sxs-lookup"><span data-stu-id="4014b-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="4014b-239">Testen van back-up en herstel</span><span class="sxs-lookup"><span data-stu-id="4014b-239">Testing Backup and Restore</span></span>
<span data-ttu-id="4014b-240">Het is belangrijk om ervoor te zorgen dat essentiële gegevens wordt back-up en kan worden hersteld vanuit.</span><span class="sxs-lookup"><span data-stu-id="4014b-240">It is important to ensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="4014b-241">Dit kan worden gedaan door het aanroepen van de `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell die verlies van gegevens in een bepaalde partitie om te controleren of de gegevens back-up en herstellen van de functionaliteit voor uw service werkt zoals verwacht kan veroorzaken.</span><span class="sxs-lookup"><span data-stu-id="4014b-241">This can be done by invoking the `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition to test whether the data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="4014b-242">Het is ook mogelijk om programmatisch aanroepen verlies van gegevens en herstellen van die gebeurtenis ook.</span><span class="sxs-lookup"><span data-stu-id="4014b-242">It is also possible to programmatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="4014b-243">U vindt een Voorbeeldimplementatie van back-up en herstel functionaliteit in de Web-App voor verwijzing op GitHub.</span><span class="sxs-lookup"><span data-stu-id="4014b-243">You can find a sample implementation of backup and restore functionality in the Web Reference App on GitHub.</span></span> <span data-ttu-id="4014b-244">Bekijk de `Inventory.Service` service voor meer informatie.</span><span class="sxs-lookup"><span data-stu-id="4014b-244">Please look at the `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-the-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="4014b-245">Achter de schermen: meer informatie over back-up en herstel</span><span class="sxs-lookup"><span data-stu-id="4014b-245">Under the hood: more details on backup and restore</span></span>
<span data-ttu-id="4014b-246">Hier volgt een aantal meer informatie over back-up en herstel.</span><span class="sxs-lookup"><span data-stu-id="4014b-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="4014b-247">Back-up</span><span class="sxs-lookup"><span data-stu-id="4014b-247">Backup</span></span>
<span data-ttu-id="4014b-248">Statusbeheer voor het betrouwbare biedt de mogelijkheid te consistente back-ups maken zonder blokkering van alle lees- of schrijfbewerkingen.</span><span class="sxs-lookup"><span data-stu-id="4014b-248">The Reliable State Manager provides the ability to create consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="4014b-249">Om dit te doen, maakt het gebruik van een mechanisme controlepunt- en logboekbestanden.</span><span class="sxs-lookup"><span data-stu-id="4014b-249">To do so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="4014b-250">Statusbeheer voor het betrouwbare duurt fuzzy (lightweight) controlepunten op bepaalde tijdstippen te ontlasten zware belasting van het logboek voor transactionele en hersteltijden te verbeteren.</span><span class="sxs-lookup"><span data-stu-id="4014b-250">The Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points to relieve pressure from the transactional log and improve recovery times.</span></span>  <span data-ttu-id="4014b-251">Wanneer `BackupAsync` wordt aangeroepen, statusbeheer voor het betrouwbare Hiermee geeft u alle objecten van betrouwbare hun meest recente om controlepuntbestanden te kopiëren naar een lokale map voor back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-251">When `BackupAsync` is called, the Reliable State Manager instructs all Reliable objects to copy their latest checkpoint files to a local backup folder.</span></span>  <span data-ttu-id="4014b-252">Statusbeheer voor het betrouwbare kopieert vervolgens alle logboekrecords vanaf de aanwijzer' start' naar de meest recente logboekrecord in de back-upmap.</span><span class="sxs-lookup"><span data-stu-id="4014b-252">Then, the Reliable State Manager copies all log records, starting from the "start pointer" to the latest log record into the backup folder.</span></span>  <span data-ttu-id="4014b-253">Aangezien de logboekrecords tot de meest recente logboekrecord zijn opgenomen in de back-up en betrouwbare statusbeheer voor het vooraf geschreven logboekregistratie behoudt, betrouwbare statusbeheer voor het zorgt ervoor dat alle transacties die toegewezen zijn (`CommitAsync` met succes heeft geretourneerd ) zijn opgenomen in de back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-253">Since all the log records up to the latest log record are included in the backup and the Reliable State Manager preserves write-ahead logging, the Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in the backup.</span></span>

<span data-ttu-id="4014b-254">De transactie die na doorvoeren `BackupAsync` mei is aangeroepen of mogelijk niet in de back-up.</span><span class="sxs-lookup"><span data-stu-id="4014b-254">Any transaction that commits after `BackupAsync` has been called may or may not be in the backup.</span></span>  <span data-ttu-id="4014b-255">Zodra de lokale back-upmap is gevuld door het platform (dat wil zeggen, lokale back-up is voltooid door de runtime), back-up van de service-callback is aangeroepen.</span><span class="sxs-lookup"><span data-stu-id="4014b-255">Once the local backup folder has been populated by the platform (i.e., local backup is completed by the runtime), the service's backup callback is invoked.</span></span>  <span data-ttu-id="4014b-256">Deze retouraanroep is verantwoordelijk voor de back-map verplaatst naar een externe locatie zoals Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="4014b-256">This callback is responsible for moving the backup folder to an external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="4014b-257">Herstellen</span><span class="sxs-lookup"><span data-stu-id="4014b-257">Restore</span></span>
<span data-ttu-id="4014b-258">Statusbeheer voor het betrouwbare biedt de mogelijkheid om terug te zetten vanuit een back-up met behulp van de `RestoreAsync` API.</span><span class="sxs-lookup"><span data-stu-id="4014b-258">The Reliable State Manager provides the ability to restore from a backup by using the `RestoreAsync` API.</span></span>  
<span data-ttu-id="4014b-259">De `RestoreAsync` methode op `RestoreContext` kan worden aangeroepen alleen in de `OnDataLossAsync` methode.</span><span class="sxs-lookup"><span data-stu-id="4014b-259">The `RestoreAsync` method on `RestoreContext` can be called only inside the `OnDataLossAsync` method.</span></span>
<span data-ttu-id="4014b-260">De bool geretourneerd door `OnDataLossAsync` geeft aan of de service hersteld van de status van een externe bron.</span><span class="sxs-lookup"><span data-stu-id="4014b-260">The bool returned by `OnDataLossAsync` indicates whether the service restored its state from an external source.</span></span>
<span data-ttu-id="4014b-261">Als de `OnDataLossAsync` true retourneert, Service Fabric alle andere replica's van deze primaire opnieuw opgebouwd.</span><span class="sxs-lookup"><span data-stu-id="4014b-261">If the `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="4014b-262">Service Fabric zorgt ervoor dat replica's die worden ontvangen `OnDataLossAsync` aanroepen van eerste overgang naar de primaire rol, maar zijn niet verleend status lezen of schrijven status.</span><span class="sxs-lookup"><span data-stu-id="4014b-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition to the primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="4014b-263">Dit houdt in dat voor StatefulService implementeerders, `RunAsync` wordt niet aangeroepen tot `OnDataLossAsync` met succes wordt voltooid.</span><span class="sxs-lookup"><span data-stu-id="4014b-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="4014b-264">Vervolgens `OnDataLossAsync` wordt aangeroepen op de nieuwe primaire.</span><span class="sxs-lookup"><span data-stu-id="4014b-264">Then, `OnDataLossAsync` will be invoked on the new primary.</span></span>
<span data-ttu-id="4014b-265">Totdat een service deze API is (met retourneert true of false voltooit) en de relevante herconfiguratie is voltooid, wordt de API behouden wordt aangeroepen één tegelijk.</span><span class="sxs-lookup"><span data-stu-id="4014b-265">Until a service completes this API successfully (by returning true or false) and finishes the relevant reconfiguration, the API will keep being called one at a time.</span></span>

<span data-ttu-id="4014b-266">`RestoreAsync`alle bestaande statussen van de primaire replica die is aangeroepen op eerst verwijderd.</span><span class="sxs-lookup"><span data-stu-id="4014b-266">`RestoreAsync` first drops all existing state in the primary replica that it was called on.</span></span>  
<span data-ttu-id="4014b-267">Statusbeheer voor het betrouwbare maakt vervolgens de betrouwbare objecten die zijn opgenomen in de back-upmap.</span><span class="sxs-lookup"><span data-stu-id="4014b-267">Then the Reliable State Manager creates all the Reliable objects that exist in the backup folder.</span></span>  
<span data-ttu-id="4014b-268">Vervolgens wordt de betrouwbare objecten terugzetten vanaf hun controlepunten in de back-upmap geïnstrueerd.</span><span class="sxs-lookup"><span data-stu-id="4014b-268">Next, the Reliable objects are instructed to restore from their checkpoints in the backup folder.</span></span>  
<span data-ttu-id="4014b-269">Ten slotte betrouwbare statusbeheer voor het eigen status vanuit de logboekrecords in de back-upmap herstelt en wordt een herstelbewerking uitgevoerd.</span><span class="sxs-lookup"><span data-stu-id="4014b-269">Finally, the Reliable State Manager recovers its own state from the log records in the backup folder and performs recovery.</span></span>  
<span data-ttu-id="4014b-270">Als onderdeel van het herstelproces worden vanaf het 'beginpunt' bewerkingen waarvoor logboekrecords doorvoeren in de back-upmap cookies op betrouwbare objecten.</span><span class="sxs-lookup"><span data-stu-id="4014b-270">As part of the recovery process, operations starting from the "starting point" that have commit log records in the backup folder are replayed to the Reliable objects.</span></span>  
<span data-ttu-id="4014b-271">Deze stap zorgt ervoor dat de status van de herstelde consistent is.</span><span class="sxs-lookup"><span data-stu-id="4014b-271">This step ensures that the recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="4014b-272">Volgende stappen</span><span class="sxs-lookup"><span data-stu-id="4014b-272">Next steps</span></span>
  - [<span data-ttu-id="4014b-273">Betrouwbare verzamelingen</span><span class="sxs-lookup"><span data-stu-id="4014b-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="4014b-274">Betrouwbare Services snel starten</span><span class="sxs-lookup"><span data-stu-id="4014b-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="4014b-275">Betrouwbare Services meldingen</span><span class="sxs-lookup"><span data-stu-id="4014b-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="4014b-276">Configuratie van betrouwbare Services</span><span class="sxs-lookup"><span data-stu-id="4014b-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="4014b-277">Referentie voor ontwikkelaars voor betrouwbare verzamelingen</span><span class="sxs-lookup"><span data-stu-id="4014b-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

