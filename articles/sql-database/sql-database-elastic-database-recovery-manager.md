---
title: aaaUsing Recovery Manager toofix shard wijzen problemen | Microsoft Docs
description: Hallo RecoveryManager klasse toosolve problemen met de shard-kaarten gebruiken
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="f62c6-103">Met behulp van Hallo RecoveryManager klasse toofix shard kaart problemen</span><span class="sxs-lookup"><span data-stu-id="f62c6-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="f62c6-104">Hallo [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) klasse biedt ADO.Net toepassingen Hallo mogelijkheid tooeasily detecteren en los eventuele inconsistenties tussen Hallo globale shard-toewijzing (GSM) en Hallo lokale shard-toewijzing (LSM) in een databaseomgeving met shard-.</span><span class="sxs-lookup"><span data-stu-id="f62c6-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="f62c6-105">Hallo GSM en LSM bijhouden Hallo toewijzing van elke database in een shard-omgeving.</span><span class="sxs-lookup"><span data-stu-id="f62c6-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="f62c6-106">In sommige gevallen kan wordt een einde ingevoegd tussen Hallo GSM en Hallo LSM.</span><span class="sxs-lookup"><span data-stu-id="f62c6-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="f62c6-107">In dat geval gebruik Hallo RecoveryManager klasse toodetect en Hallo break herstellen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="f62c6-108">Hallo RecoveryManager klasse maakt deel uit van Hallo [clientbibliotheek voor elastische Database](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="f62c6-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Shard-kaart][1]

<span data-ttu-id="f62c6-110">Zie voor definities van de termijn [verklarende woordenlijst hulpprogramma's van elastische Database](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="f62c6-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="f62c6-111">toounderstand hoe Hallo **ShardMapManager** gebruikte toomanage gegevens in een shard-oplossing, Zie [Shard kaart management](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="f62c6-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="f62c6-112">Waarom Hallo recovery manager gebruiken?</span><span class="sxs-lookup"><span data-stu-id="f62c6-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="f62c6-113">In een databaseomgeving shard-is een tenant per database en veel databases per server.</span><span class="sxs-lookup"><span data-stu-id="f62c6-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="f62c6-114">Er kan ook worden veel servers in Hallo-omgeving.</span><span class="sxs-lookup"><span data-stu-id="f62c6-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="f62c6-115">Elke database, is toegewezen in Hallo shard-kaart, zodat aanroepen gerouteerd toohello juiste server en database worden kunnen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="f62c6-116">Databases worden bijgehouden volgens tooa **sharding sleutel**, en elke shard is toegewezen een **sleutel waardenbereik**.</span><span class="sxs-lookup"><span data-stu-id="f62c6-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="f62c6-117">Een sharding-sleutel kan vertegenwoordigen bijvoorbeeld Hallo klantnamen uit "D" te 'F.'</span><span class="sxs-lookup"><span data-stu-id="f62c6-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="f62c6-118">Hallo toewijzing van alle shards (aka databases) en hun toewijzing bereiken zijn opgenomen in Hallo **globale shard-toewijzing (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="f62c6-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="f62c6-119">Elke database bevat een overzicht van Hallo bereiken op Hallo shard waarvan bekend is als Hallo opgenomen **lokale shard-toewijzing (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="f62c6-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="f62c6-120">Wanneer een app verbinding tooa shard maakt, Hallo toewijzing in de cache geplaatst met Hallo-app voor snel ophalen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="f62c6-121">Hallo LSM is gebruikte toovalidate in de cache opgeslagen gegevens.</span><span class="sxs-lookup"><span data-stu-id="f62c6-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="f62c6-122">Hallo GSM en LSM mogelijk niet synchroon voor Hallo volgende redenen:</span><span class="sxs-lookup"><span data-stu-id="f62c6-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="f62c6-123">Hallo-verwijdering van een shard waarvan bereik ervan uit langer toono dat gaat zijn in gebruik of de naam wijzigen van een shard.</span><span class="sxs-lookup"><span data-stu-id="f62c6-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="f62c6-124">Verwijderen van een shard resulteert in een **shard-toewijzing zwevende**.</span><span class="sxs-lookup"><span data-stu-id="f62c6-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="f62c6-125">Op deze manier kan een nieuwe naam database leiden tot een zwevende shard-toewijzing.</span><span class="sxs-lookup"><span data-stu-id="f62c6-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="f62c6-126">Afhankelijk van hetzelfde doel Hallo Hallo wijziging Hallo shard wellicht toobe verwijderd of Hallo shard-locatie moet toobe bijgewerkt.</span><span class="sxs-lookup"><span data-stu-id="f62c6-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="f62c6-127">Zie een verwijderde database toorecover [een verwijderde database terugzetten](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="f62c6-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="f62c6-128">Een geo-failover van de gebeurtenis.</span><span class="sxs-lookup"><span data-stu-id="f62c6-128">A geo-failover event occurs.</span></span> <span data-ttu-id="f62c6-129">toocontinue, moet een Hallo-servernaam en databasenaam van shard-toewijzing manager in de toepassing hello en vervolgens details van de update Hallo shard-toewijzing voor alle shards in een shard-toewijzing bijwerken.</span><span class="sxs-lookup"><span data-stu-id="f62c6-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="f62c6-130">Als er een geo-failover, moet deze logica herstel binnen de werkstroom van Hallo worden geautomatiseerd.</span><span class="sxs-lookup"><span data-stu-id="f62c6-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="f62c6-131">Herstelacties automatiseren kunt een frictionless beheerbaarheid voor geo geschikte databases en handmatige menselijke acties voorkomt.</span><span class="sxs-lookup"><span data-stu-id="f62c6-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="f62c6-132">toolearn over opties toorecover een database als er een datacentrum Zie [bedrijfscontinuïteit](sql-database-business-continuity.md) en [herstel na noodgevallen](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="f62c6-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="f62c6-133">Een shard- of Hallo ShardMapManager-database is een herstelde tooan eerdere punt in tijd.</span><span class="sxs-lookup"><span data-stu-id="f62c6-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="f62c6-134">toolearn over herstelpunt met behulp van back-ups, Zie [herstel met behulp van back-ups](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="f62c6-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="f62c6-135">Zie voor meer informatie over Azure SQL Database elastische Database-hulpprogramma's, geo-replicatie en terugzetten Hallo volgende:</span><span class="sxs-lookup"><span data-stu-id="f62c6-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="f62c6-136">Overzicht: Cloud zakelijke continuïteit en database noodherstel met SQL Database</span><span class="sxs-lookup"><span data-stu-id="f62c6-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="f62c6-137">Aan de slag met hulpprogramma's voor elastische database</span><span class="sxs-lookup"><span data-stu-id="f62c6-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="f62c6-138">ShardMap Management</span><span class="sxs-lookup"><span data-stu-id="f62c6-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="f62c6-139">RecoveryManager ophalen uit een ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="f62c6-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="f62c6-140">de eerste stap Hallo is toocreate een RecoveryManager-exemplaar.</span><span class="sxs-lookup"><span data-stu-id="f62c6-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="f62c6-141">Hallo [GetRecoveryManager methode](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) retourneert Hallo recovery manager voor de huidige Hallo [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) exemplaar.</span><span class="sxs-lookup"><span data-stu-id="f62c6-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="f62c6-142">tooaddress inconsistenties in de shard Hallo toewijzen, moet u eerst Hallo RecoveryManager voor bepaalde shard-kaart Hallo ophalen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="f62c6-143">In dit voorbeeld is Hallo RecoveryManager van Hallo ShardMapManager geïnitialiseerd.</span><span class="sxs-lookup"><span data-stu-id="f62c6-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="f62c6-144">Hallo ShardMapManager met een ShardMap is ook al geïnitialiseerd.</span><span class="sxs-lookup"><span data-stu-id="f62c6-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="f62c6-145">Omdat deze toepassingscode hello shard-toewijzing zelf bewerkt, referenties die worden gebruikt in fabrieksmethode Hallo Hallo (in het voorgaande voorbeeld Hallo smmConnectionString) moet de referenties die alleen-lezen-machtigingen op Hallo GSM database waarnaar wordt verwezen door Hallo hebben verbindingstekenreeks.</span><span class="sxs-lookup"><span data-stu-id="f62c6-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="f62c6-146">Deze referenties zijn meestal af van de verbindingen van tooopen referenties die worden gebruikt voor het doorsturen van afhankelijk zijn van gegevens.</span><span class="sxs-lookup"><span data-stu-id="f62c6-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="f62c6-147">Zie voor meer informatie [met behulp van referenties in Hallo elastische databaseclient](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="f62c6-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="f62c6-148">Verwijderen van een shard uit Hallo ShardMap nadat een shard is verwijderd</span><span class="sxs-lookup"><span data-stu-id="f62c6-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="f62c6-149">Hallo [DetachShard methode](https://msdn.microsoft.com/library/azure/dn842083.aspx) hello shard gegeven uit Hallo shard-toewijzing wordt losgekoppeld en toewijzingen die zijn gekoppeld aan Hallo shard verwijderd.</span><span class="sxs-lookup"><span data-stu-id="f62c6-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="f62c6-150">Hallo locatieparameter is Hallo shard locatie, speciaal servernaam en databasenaam van Hallo shard wordt losgekoppeld.</span><span class="sxs-lookup"><span data-stu-id="f62c6-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="f62c6-151">Hallo shardMapName parameter is Hallo shard toewijzingsnaam.</span><span class="sxs-lookup"><span data-stu-id="f62c6-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="f62c6-152">Dit is alleen vereist wanneer meerdere shard-maps worden beheerd door Hallo dezelfde shard-toewijzing manager.</span><span class="sxs-lookup"><span data-stu-id="f62c6-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="f62c6-153">Optioneel.</span><span class="sxs-lookup"><span data-stu-id="f62c6-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="f62c6-154">Deze methode alleen gebruiken als u er zeker van bent dat Hallo bereik voor het toewijzen van Hallo bijgewerkt leeg is.</span><span class="sxs-lookup"><span data-stu-id="f62c6-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="f62c6-155">Hallo-methoden die hierboven niet controleren voor Hallo bereik worden verplaatst, dus is het beste tooinclude controleert in uw code.</span><span class="sxs-lookup"><span data-stu-id="f62c6-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="f62c6-156">In dit voorbeeld verwijdert shards uit Hallo shard-toewijzing.</span><span class="sxs-lookup"><span data-stu-id="f62c6-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="f62c6-157">Hallo shard-toewijzing weerspiegelt Hallo shard-locatie in Hallo GSM vóór de verwijdering van shard Hallo Hallo.</span><span class="sxs-lookup"><span data-stu-id="f62c6-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="f62c6-158">Omdat Hallo shard is verwijderd, wordt ervan uitgegaan dit opzettelijk was en Hallo sharding sleutel bereik is niet langer in gebruik.</span><span class="sxs-lookup"><span data-stu-id="f62c6-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="f62c6-159">Als dat niet het geval is, kunt u een punt in tijd herstel uitvoeren.</span><span class="sxs-lookup"><span data-stu-id="f62c6-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="f62c6-160">toorecover hello shard van een eerder punt in tijd.</span><span class="sxs-lookup"><span data-stu-id="f62c6-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="f62c6-161">(Raadpleeg Hallo volgende sectie In dat geval toodetect shard inconsistenties.) toorecover, Zie [herstelpunt](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="f62c6-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="f62c6-162">Omdat ervan wordt uitgegaan verwijderen van een database Hallo opzettelijk was, hello laatste beheerdersrechten opschonen actie is toodelete Hallo vermelding toohello shard in Hallo shard-toewijzing beheer.</span><span class="sxs-lookup"><span data-stu-id="f62c6-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="f62c6-163">Dit voorkomt dat Hallo toepassing per ongeluk schrijven informatie tooa bereik dat wordt niet verwacht.</span><span class="sxs-lookup"><span data-stu-id="f62c6-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="f62c6-164">toodetect toewijzing verschillen</span><span class="sxs-lookup"><span data-stu-id="f62c6-164">toodetect mapping differences</span></span>
<span data-ttu-id="f62c6-165">Hallo [DetectMappingDifferences methode](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selecteert en retourneert een van de Hallo shard maps (lokaal of globaal) als bron van waarheid Hallo en toewijzingen op beide kaarten shard (GSM en LSM) voor overeenstemming zorgt.</span><span class="sxs-lookup"><span data-stu-id="f62c6-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="f62c6-166">Hallo *locatie* Hallo-servernaam en de databasenaam.</span><span class="sxs-lookup"><span data-stu-id="f62c6-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="f62c6-167">Hallo *shardMapName* -parameter is Hallo shard toewijzingsnaam.</span><span class="sxs-lookup"><span data-stu-id="f62c6-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="f62c6-168">Dit is alleen vereist als er meerdere shard-maps worden beheerd door Hallo dezelfde shard-toewijzing manager.</span><span class="sxs-lookup"><span data-stu-id="f62c6-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="f62c6-169">Optioneel.</span><span class="sxs-lookup"><span data-stu-id="f62c6-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="f62c6-170">tooresolve toewijzing verschillen</span><span class="sxs-lookup"><span data-stu-id="f62c6-170">tooresolve mapping differences</span></span>
<span data-ttu-id="f62c6-171">Hallo [ResolveMappingDifferences methode](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selecteert u een van de Hallo shard maps (lokaal of globaal) als bron van waarheid Hallo en toewijzingen op beide kaarten shard (GSM en LSM) voor overeenstemming zorgt.</span><span class="sxs-lookup"><span data-stu-id="f62c6-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="f62c6-172">Hallo *RecoveryToken* parameter Hallo verschillen in Hallo toewijzingen tussen Hallo GSM en Hallo LSM voor Hallo specifieke shard inventariseert.</span><span class="sxs-lookup"><span data-stu-id="f62c6-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="f62c6-173">Hallo [MappingDifferenceResolution opsomming](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) gebruikte tooindicate Hallo methode voor het oplossen van Hallo verschil tussen Hallo shard toewijzingen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="f62c6-174">**MappingDifferenceResolution.KeepShardMapping** is raadzaam om bij Hallo LSM nauwkeurige toewijzing Hallo bevat en daarom Hallo toewijzing in Hallo shard moet worden gebruikt.</span><span class="sxs-lookup"><span data-stu-id="f62c6-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="f62c6-175">Dit is doorgaans Hallo geval als er een failover: Hallo shard zich nu bevindt op een nieuwe server.</span><span class="sxs-lookup"><span data-stu-id="f62c6-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="f62c6-176">Aangezien Hallo shard moet eerst worden verwijderd uit Hallo GSM (met Hallo RecoveryManager.DetachShard methode), bestaat een toewijzing niet meer op Hallo GSM.</span><span class="sxs-lookup"><span data-stu-id="f62c6-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="f62c6-177">Hallo LSM moet daarom gebruikte toore-Hallo shard-toewijzing tot stand brengen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="f62c6-178">Een shard-toohello ShardMap koppelen nadat een shard is hersteld</span><span class="sxs-lookup"><span data-stu-id="f62c6-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="f62c6-179">Hallo [AttachShard methode](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) wordt Hallo opgegeven shard toohello shard-toewijzing.</span><span class="sxs-lookup"><span data-stu-id="f62c6-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="f62c6-180">Inconsistenties kaart shard detecteert en het Hallo toewijzingen toomatch hello shard op Hallo punt Hallo shard herstelprocedure-updates.</span><span class="sxs-lookup"><span data-stu-id="f62c6-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="f62c6-181">Ervan wordt uitgegaan dat Hallo de database ook hernoemde tooreflect Hallo oorspronkelijke databasenaam (voordat Hallo shard is hersteld), aangezien Hallo punt in tijd herstelbewerking standaard tooa nieuwe database met Hallo tijdstempel toegevoegd.</span><span class="sxs-lookup"><span data-stu-id="f62c6-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="f62c6-182">Hallo *locatie* parameter is Hallo-servernaam en databasenaam van Hallo shard wordt gekoppeld.</span><span class="sxs-lookup"><span data-stu-id="f62c6-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="f62c6-183">Hallo *shardMapName* -parameter is Hallo shard toewijzingsnaam.</span><span class="sxs-lookup"><span data-stu-id="f62c6-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="f62c6-184">Dit is alleen vereist wanneer meerdere shard-maps worden beheerd door Hallo dezelfde shard-toewijzing manager.</span><span class="sxs-lookup"><span data-stu-id="f62c6-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="f62c6-185">Optioneel.</span><span class="sxs-lookup"><span data-stu-id="f62c6-185">Optional.</span></span> 

<span data-ttu-id="f62c6-186">Dit voorbeeld wordt een shard toohello shard-toewijzing die onlangs is hersteld van een eerder tijdstip punt in.</span><span class="sxs-lookup"><span data-stu-id="f62c6-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="f62c6-187">Aangezien Hallo shard (namelijk hello toewijzing voor Hallo shard in Hallo LSM) is hersteld, is het mogelijk inconsistent is met Hallo shard-vermelding in Hallo GSM.</span><span class="sxs-lookup"><span data-stu-id="f62c6-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="f62c6-188">Buiten deze voorbeeldcode Hallo shard is hersteld en toohello oorspronkelijke naam van de database Hallo gewijzigd.</span><span class="sxs-lookup"><span data-stu-id="f62c6-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="f62c6-189">Omdat deze is teruggezet, wordt ervan uitgegaan Hallo toewijzing in Hallo LSM Hallo vertrouwde toewijzing.</span><span class="sxs-lookup"><span data-stu-id="f62c6-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="f62c6-190">Bijwerken van shard-locaties na een geo-failover (herstel) van Hallo shards</span><span class="sxs-lookup"><span data-stu-id="f62c6-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="f62c6-191">Als er een geo-failover, staat Hallo secundaire database schrijven toegankelijk en wordt de nieuwe primaire database Hallo.</span><span class="sxs-lookup"><span data-stu-id="f62c6-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="f62c6-192">Hallo naam van het Hallo-server en mogelijk Hallo-database (afhankelijk van uw configuratie), kan afwijken van de oorspronkelijke primaire Hallo.</span><span class="sxs-lookup"><span data-stu-id="f62c6-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="f62c6-193">Daarom Hallo toewijzingen voor Hallo shard in Hallo GSM en LSM moet worden vastgesteld.</span><span class="sxs-lookup"><span data-stu-id="f62c6-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="f62c6-194">Op dezelfde manier als Hallo-database is teruggezet tooa andere naam of locatie of tooan eerdere punt in tijd hierdoor mogelijk inconsistenties Hallo shard Maps.</span><span class="sxs-lookup"><span data-stu-id="f62c6-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="f62c6-195">Hallo Shard kaart Manager verwerkt Hallo distributie van geopende verbindingen toohello juiste database.</span><span class="sxs-lookup"><span data-stu-id="f62c6-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="f62c6-196">Distributie is gebaseerd op Hallo-gegevens in Hallo shard-toewijzing en Hallo-waarde van Hallo sharding-sleutel die Hallo doel van Hallo toepassingen aanvraag.</span><span class="sxs-lookup"><span data-stu-id="f62c6-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="f62c6-197">Na een geo-failover, moet deze gegevens worden bijgewerkt met de Hallo nauwkeurige servernaam, databasenaam en shard-toewijzing van de herstelde database Hallo.</span><span class="sxs-lookup"><span data-stu-id="f62c6-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="f62c6-198">Aanbevolen procedures</span><span class="sxs-lookup"><span data-stu-id="f62c6-198">Best practices</span></span>
<span data-ttu-id="f62c6-199">Zijn gewoonlijk beheerd door een cloudbeheerder van Hallo van een toepassing met opzet op een Azure SQL-Databases zakelijke continuïteit functies operations geo-failover en herstel.</span><span class="sxs-lookup"><span data-stu-id="f62c6-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="f62c6-200">Zakelijke continuïteit planning vereist processen, procedures en metingen tooensure die zakelijke activiteiten zonder onderbreking kunnen worden voortgezet.</span><span class="sxs-lookup"><span data-stu-id="f62c6-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="f62c6-201">Hallo methoden beschikbaar als onderdeel van Hallo RecoveryManager klasse moet worden gebruikt binnen deze werkstroom tooensure Hallo GSM en LSM altijd zijn bijgewerkt op basis van de uitgevoerde actie Hallo herstel.</span><span class="sxs-lookup"><span data-stu-id="f62c6-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="f62c6-202">Er zijn vijf eenvoudige stappen tooproperly gezorgd Hallo GSM en LSM weerspiegelen Hallo nauwkeurige informatie na een failover.</span><span class="sxs-lookup"><span data-stu-id="f62c6-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="f62c6-203">Hallo toepassing code tooexecute die deze stappen kunnen worden geïntegreerd in de werkstroom en bestaande hulpprogramma's.</span><span class="sxs-lookup"><span data-stu-id="f62c6-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="f62c6-204">Hallo RecoveryManager uit Hallo ShardMapManager ophalen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="f62c6-205">Loskoppelen van de oude shard Hallo uit Hallo shard-toewijzing.</span><span class="sxs-lookup"><span data-stu-id="f62c6-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="f62c6-206">Hallo nieuwe shard toohello shard kaart, inclusief nieuwe shard-locatie Hallo koppelen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="f62c6-207">Inconsistenties in de toewijzing tussen Hallo GSM en LSM Hallo detecteren.</span><span class="sxs-lookup"><span data-stu-id="f62c6-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="f62c6-208">Verschillen tussen Hallo GSM en Hallo LSM, vertrouwende Hallo LSM oplossen.</span><span class="sxs-lookup"><span data-stu-id="f62c6-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="f62c6-209">In dit voorbeeld voert Hallo stappen te volgen:</span><span class="sxs-lookup"><span data-stu-id="f62c6-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="f62c6-210">Hiermee verwijdert u shards uit Hallo Shard-toewijzing die aan shard-locaties voordat Hallo failover-gebeurtenis.</span><span class="sxs-lookup"><span data-stu-id="f62c6-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="f62c6-211">Shards toohello Shard-toewijzing reflecterende Hallo nieuwe shard locaties koppelt (Hallo parameter 'Configuration.SecondaryServer' hello nieuwe servernaam is, maar Hallo dezelfde databasenaam).</span><span class="sxs-lookup"><span data-stu-id="f62c6-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="f62c6-212">Haalt Hallo herstel tokens door toewijzing verschillen tussen Hallo GSM en Hallo LSM voor elke shard detecteren.</span><span class="sxs-lookup"><span data-stu-id="f62c6-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="f62c6-213">Hallo inconsistenties oplossing door vertrouwende Hallo-toewijzing van Hallo LSM van elke shard.</span><span class="sxs-lookup"><span data-stu-id="f62c6-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

