---
title: Een Azure Automation-runbook aanroepen vanuit een Log Analytics-waarschuwing | Microsoft Docs
description: Dit artikel bevat een overzicht van hoe u een Automation-runbook aanroept vanuit een Microsoft OMS Log Analytics-waarschuwing.
services: automation
documentationcenter: 
author: mgoedtel
manager: jwhit
editor: 
ms.assetid: 
ms.service: automation
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 01/31/2017
ms.author: magoedte
ms.openlocfilehash: 81cf490eae7f283c0180875cb3a2ed2ffe6333c8
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 07/11/2017
---
# <a name="calling-an-azure-automation-runbook-from-an-oms-log-analytics-alert"></a><span data-ttu-id="d8ced-103">Een Azure Automation-runbook aanroepen vanuit een Log Analytics-waarschuwing</span><span class="sxs-lookup"><span data-stu-id="d8ced-103">Calling an Azure Automation runbook from an OMS Log Analytics alert</span></span>

<span data-ttu-id="d8ced-104">Wanneer er in Log Analytics een waarschuwing is geconfigureerd om een waarschuwingsrecord te maken als resultaten overeenkomen met bepaalde criteria (zoals een langdurige piek in CPU-gebruik of als een bepaald toepassingsproces dat essentieel is voor de functionaliteit van een bedrijfstoepassing, mislukt en een overeenkomende gebeurtenis naar het Windows-gebeurtenislogboek schrijft), kan deze waarschuwing automatisch een Automation-runbook uitvoeren in een poging om het probleem automatisch op te lossen.</span><span class="sxs-lookup"><span data-stu-id="d8ced-104">When an alert is configured in Log Analytics to create an alert record if results match a particular criteria, such as a prolonged spike in processor utilization or a particular application process critical to the functionality of a business application fails and writes a corresponding event in the Windows event log, that alert can automatically run an Automation runbook in an attempt to auto-remediate the issue.</span></span>  

<span data-ttu-id="d8ced-105">Tijdens het configureren van de waarschuwing hebt u twee opties voor het aanroepen van een runbook.</span><span class="sxs-lookup"><span data-stu-id="d8ced-105">There are two options to call a runbook when configuring the alert.</span></span>  <span data-ttu-id="d8ced-106">Met name:</span><span class="sxs-lookup"><span data-stu-id="d8ced-106">Specifically,</span></span>

1. <span data-ttu-id="d8ced-107">Een webhook gebruiken.</span><span class="sxs-lookup"><span data-stu-id="d8ced-107">Using a Webhook.</span></span>
   * <span data-ttu-id="d8ced-108">Dit is de enige beschikbare optie als uw OMS-werkruimte niet is gekoppeld aan een Automation-account.</span><span class="sxs-lookup"><span data-stu-id="d8ced-108">This is the only option available if your OMS workspace is not linked to an Automation account.</span></span>
   * <span data-ttu-id="d8ced-109">Als u al een Automation-account hebt gekoppeld aan een OMS-werkruimte, is deze optie ook nog steeds beschikbaar.</span><span class="sxs-lookup"><span data-stu-id="d8ced-109">If you already have an Automation account linked to an OMS workspace, this option is still available.</span></span>  

2. <span data-ttu-id="d8ced-110">Een runbook direct selecteren.</span><span class="sxs-lookup"><span data-stu-id="d8ced-110">Select a runbook directly.</span></span>
   * <span data-ttu-id="d8ced-111">Deze optie is alleen beschikbaar wanneer de OMS-werkruimte is gekoppeld aan een Automation-account.</span><span class="sxs-lookup"><span data-stu-id="d8ced-111">This option is available only when the OMS workspace is linked to an Automation account.</span></span>  

## <a name="calling-a-runbook-using-a-webhook"></a><span data-ttu-id="d8ced-112">Een runbook aanroepen met behulp van een webhook</span><span class="sxs-lookup"><span data-stu-id="d8ced-112">Calling a runbook using a webhook</span></span>

<span data-ttu-id="d8ced-113">Met een webhook kunt u een bepaald runbook in Azure Automation starten via een afzonderlijke HTTP-aanvraag.</span><span class="sxs-lookup"><span data-stu-id="d8ced-113">A webhook allows you to start a particular runbook in Azure Automation through a single HTTP request.</span></span>  <span data-ttu-id="d8ced-114">Voordat u de [Log Analytics-waarschuwing](../log-analytics/log-analytics-alerts.md#alert-rules) configureert om het runbook aan te roepen met behulp van een webhook als waarschuwingsactie, moet u een webhook voor het runbook maken dat met deze methode wordt aangeroepen.</span><span class="sxs-lookup"><span data-stu-id="d8ced-114">Before configuring the [Log Analytics alert](../log-analytics/log-analytics-alerts.md#alert-rules) to call the runbook using a webhook as an alert action, you will need to first create a webhook for the runbook that will be called using this method.</span></span>  <span data-ttu-id="d8ced-115">Bekijk en volg de stappen in het artikel [Create a webhook](automation-webhooks.md#creating-a-webhook) (Een webhook maken) en vergeet niet om de webhook-URL te registreren, zodat u ernaar kunt verwijzen tijdens het configureren van de waarschuwingsregel.</span><span class="sxs-lookup"><span data-stu-id="d8ced-115">Review and follow the steps in the [create a webhook](automation-webhooks.md#creating-a-webhook) article and remember to record the webhook URL so that you can reference it while configuring the alert rule.</span></span>   

## <a name="calling-a-runbook-directly"></a><span data-ttu-id="d8ced-116">Een runbook direct aanroepen</span><span class="sxs-lookup"><span data-stu-id="d8ced-116">Calling a runbook directly</span></span>

<span data-ttu-id="d8ced-117">Als u Automation & Control in uw OMS-werkruimte hebt geïnstalleerd en geconfigureerd, kunt u tijdens de configuratie van de opties voor runbookacties alle runbooks in de vervolgkeuzelijst **Een runbook selecteren** bekijken en het runbook selecteren dat u wilt uitvoeren als reactie op de waarschuwing.</span><span class="sxs-lookup"><span data-stu-id="d8ced-117">If you have the Automation & Control offering installed and configured in your OMS workspace, when configuring the Runbook actions option for the alert, you can view all runbooks from the **Select a runbook** dropdown list and select the specific runbook you want to run in response to the alert.</span></span>  <span data-ttu-id="d8ced-118">Het geselecteerde runbook kan worden uitgevoerd in een werkruimte in de Azure-cloud of op een Hybrid Runbook Worker.</span><span class="sxs-lookup"><span data-stu-id="d8ced-118">The selected runbook can run in a workspace in the Azure cloud or on a hybrid runbook worker.</span></span>  <span data-ttu-id="d8ced-119">Wanneer de waarschuwing is gemaakt met de runbookoptie, wordt er een webhook voor het runbook gemaakt.</span><span class="sxs-lookup"><span data-stu-id="d8ced-119">When the alert is created using the runbook option, a webhook will be created for the runbook.</span></span>  <span data-ttu-id="d8ced-120">U kunt de webhook zien als u naar het Automation-account gaat en naar de blade Webhook van het geselecteerde runbook navigeert.</span><span class="sxs-lookup"><span data-stu-id="d8ced-120">You can see the webhook if you go to the Automation account and navigate to the webhook blade of the selected runbook.</span></span>  <span data-ttu-id="d8ced-121">Als u de waarschuwing verwijdert, wordt de webhook niet verwijderd. De gebruiker kan de webhook wel handmatig verwijderen.</span><span class="sxs-lookup"><span data-stu-id="d8ced-121">If you delete the alert, the webhook is not deleted, but the user can delete the webhook manually.</span></span>  <span data-ttu-id="d8ced-122">Het is geen probleem als de webhook niet wordt verwijderd. Het is alleen een zwevend item dat uiteindelijk moet worden verwijderd om een georganiseerd Automation-account te behouden.</span><span class="sxs-lookup"><span data-stu-id="d8ced-122">It is not a problem if the webhook is not deleted, it is just an orphaned item that will eventually need to be deleted in order to maintain an organized Automation account.</span></span>  

## <a name="characteristics-of-a-runbook-for-both-options"></a><span data-ttu-id="d8ced-123">Kenmerken van een runbook (voor beide opties)</span><span class="sxs-lookup"><span data-stu-id="d8ced-123">Characteristics of a runbook (for both options)</span></span>

<span data-ttu-id="d8ced-124">Beide methoden voor het aanroepen van het runbook vanuit de Log Analytics-waarschuwing hebben eigen gedragskenmerken. Het is belangrijk dat u deze begrijpt voordat u de waarschuwingsregels gaat configureren.</span><span class="sxs-lookup"><span data-stu-id="d8ced-124">Both methods for calling the runbook from the Log Analytics alert have different behavior characteristics that need to be understood before you configure your alert rules.</span></span>  

* <span data-ttu-id="d8ced-125">U moet een runbook-invoerparameter hebben met de naam **WebhookData** en van het type **Object**.</span><span class="sxs-lookup"><span data-stu-id="d8ced-125">You must have a runbook input parameter called **WebhookData** that is **Object** type.</span></span>  <span data-ttu-id="d8ced-126">Deze kan verplicht of optioneel zijn.</span><span class="sxs-lookup"><span data-stu-id="d8ced-126">It can be mandatory or optional.</span></span>  <span data-ttu-id="d8ced-127">Met deze invoerparameter geeft de waarschuwing de zoekresultaten door aan het runbook.</span><span class="sxs-lookup"><span data-stu-id="d8ced-127">The alert passes the search results to the runbook using this input parameter.</span></span>

        param  
         (  
          [Parameter (Mandatory=$true)]  
          [object] $WebhookData  
         )

*  <span data-ttu-id="d8ced-128">U moet code hebben om de WebhookData te converteren naar een PowerShell-object.</span><span class="sxs-lookup"><span data-stu-id="d8ced-128">You must have code to convert the WebhookData to a PowerShell object.</span></span>

    `$SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value`

    <span data-ttu-id="d8ced-129">*$SearchResults* is een matrix met objecten; elk object bevat de velden met waarden uit één zoekresultaat</span><span class="sxs-lookup"><span data-stu-id="d8ced-129">*$SearchResults* will be an array of objects; each object contains the fields with values from one search result</span></span>

### <a name="webhookdata-inconsistencies-between-the-webhook-option-and-runbook-option"></a><span data-ttu-id="d8ced-130">WebhookData-inconsistenties tussen de webhook-optie en runbook-optie</span><span class="sxs-lookup"><span data-stu-id="d8ced-130">WebhookData inconsistencies between the webhook option and runbook option</span></span>

* <span data-ttu-id="d8ced-131">Wanneer u een waarschuwing configureert om een webhook aan te roepen, voert u een webhook-URL in die u voor een runbook hebt gemaakt en klikt u op de knop **Webhook testen**.</span><span class="sxs-lookup"><span data-stu-id="d8ced-131">When configuring an alert to call a Webhook, enter a webhook URL you created for a runbook, and click the **Test Webhook** button.</span></span>  <span data-ttu-id="d8ced-132">De resulterende WebhookData die naar het runbook worden verzonden, bevat geen *.SearchResult* of *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="d8ced-132">The resulting WebhookData sent to the runbook does not contain either *.SearchResult* or *.SearchResults*.</span></span>

*  <span data-ttu-id="d8ced-133">Als u deze waarschuwing opslaat, bevat de WebhookData die naar het runbook wordt verzonden, *.SearchResult* wanneer de waarschuwing de webhook activeert en aanroept.</span><span class="sxs-lookup"><span data-stu-id="d8ced-133">If you save that alert, when the alert triggers and calls the webhook, the WebhookData sent to the runbook contains *.SearchResult*.</span></span>
* <span data-ttu-id="d8ced-134">Als u een waarschuwing maakt en configureert om een runbook aan te roepen (waardoor ook een webhook wordt gemaakt), wordt WebhookData met *.SearchResults* naar het runbook verzonden wanneer de waarschuwing wordt geactiveerd.</span><span class="sxs-lookup"><span data-stu-id="d8ced-134">If you create an alert, and configure it to call a runbook (which also creates a webhook), when the alert triggers it sends WebhookData to the runbook that contains *.SearchResults*.</span></span>

<span data-ttu-id="d8ced-135">In bovenstaand codevoorbeeld moet u dus *.SearchResult* ophalen als de waarschuwing een webhook aanroept en *.SearchResults* als de waarschuwing een runbook rechtstreeks aanroept.</span><span class="sxs-lookup"><span data-stu-id="d8ced-135">Thus in the code example above, you will need to get *.SearchResult* if the alert calls a webhook, and will need to get *.SearchResults* if the alert calls a runbook directly.</span></span>

## <a name="example-walkthrough"></a><span data-ttu-id="d8ced-136">Voorbeeldscenario</span><span class="sxs-lookup"><span data-stu-id="d8ced-136">Example walkthrough</span></span>

<span data-ttu-id="d8ced-137">U ziet hoe dit werkt in het volgende grafische voorbeeldrunbook waarmee een Windows-service wordt gestart.</span><span class="sxs-lookup"><span data-stu-id="d8ced-137">We will demonstrate how this works by using the following example graphical runbook, which starts a Windows service.</span></span><br><br> ![Grafisch runbook dat Windows-service start](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice.png)<br>

<span data-ttu-id="d8ced-139">Het runbook heeft één invoerparameter van het type **Object**. De parameter heet **WebhookData** en bevat de webhookgegevens die zijn doorgegeven door de waarschuwing die *.SearchResults* bevat.</span><span class="sxs-lookup"><span data-stu-id="d8ced-139">The runbook has one input parameter of type **Object** that is called **WebhookData** and includes the webhook data passed from the alert containing *.SearchResults*.</span></span><br><br> <span data-ttu-id="d8ced-140">![Invoerparameters voor runbook](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span><span class="sxs-lookup"><span data-stu-id="d8ced-140">![Runbook input parameters](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span></span><br>

<span data-ttu-id="d8ced-141">Voor dit voorbeeld zijn in Log Analytics twee aangepaste velden gemaakt: *SvcDisplayName_CF* en *SvcState_CF*. Deze dienen om de weergavenaam en de status van de service (Wordt uitgevoerd of Gestopt) op te halen uit de gebeurtenis die naar het logboek voor systeemgebeurtenissen is geschreven.</span><span class="sxs-lookup"><span data-stu-id="d8ced-141">For this example, in Log Analytics we created two custom fields, *SvcDisplayName_CF* and *SvcState_CF*, to extract the service display name and the state of the service (i.e. running or stopped) from the event written to the System event log.</span></span>  <span data-ttu-id="d8ced-142">Vervolgens is een waarschuwingsregel met de volgende query gemaakt: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` zodat kan worden gedetecteerd wanneer de afdrukspoolerservice op het Windows-systeem is gestopt.</span><span class="sxs-lookup"><span data-stu-id="d8ced-142">We then create an alert rule with the following search query: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` so that we can detect when the Print Spooler service is stopped on the Windows system.</span></span>  <span data-ttu-id="d8ced-143">Dit kan ook een andere service zijn, maar voor dit voorbeeld is gebruikgemaakt van een bestaande service die deel uitmaakt van het Windows-besturingssysteem.</span><span class="sxs-lookup"><span data-stu-id="d8ced-143">It can be any service of interest, but for this example we are referencing one of the pre-existing services that are included with the Windows OS.</span></span>  <span data-ttu-id="d8ced-144">De actie bij waarschuwing is geconfigureerd om het runbook uit dit voorbeeld uit te voeren en om te worden uitgevoerd op Hybrid Runbook Worker, dat is ingeschakeld op de doelsystemen.</span><span class="sxs-lookup"><span data-stu-id="d8ced-144">The alert action is configured to execute our runbook used in this example and run on the Hybrid Runbook Worker, which are enabled on the target systems.</span></span>   

<span data-ttu-id="d8ced-145">De activiteit **Get Service Name from LA** in de runbookcode converteert de tekenreeks in JSON-indeling naar een objecttype en filtert op het item *SvcDisplayName_CF* om de weergavenaam van de Windows-service te verkrijgen. Deze wordt doorgegeven aan de volgende activiteit, die controleert of de service is gestopt voordat wordt geprobeerd de service opnieuw te starten.</span><span class="sxs-lookup"><span data-stu-id="d8ced-145">The runbook code activity **Get Service Name from LA** will convert the JSON-formatted string into an object type and filter on the item *SvcDisplayName_CF* to extract the display name of the Windows service and pass this onto the next activity which will verify the service is stopped before attempting to restart it.</span></span>  <span data-ttu-id="d8ced-146">*SvcDisplayName_CF* is een [aangepast](../log-analytics/log-analytics-custom-fields.md) veld dat in Log Analytics is gemaakt voor dit voorbeeld.</span><span class="sxs-lookup"><span data-stu-id="d8ced-146">*SvcDisplayName_CF* is a [custom field](../log-analytics/log-analytics-custom-fields.md) created in Log Analytics to demonstrate this example.</span></span>

    $SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value
    $SearchResults.SvcDisplayName_CF  

<span data-ttu-id="d8ced-147">Wanneer de service stopt, wordt er door de waarschuwingsregel in Log Analytics een overeenkomst gedetecteerd en het runbook geactiveerd. Daarbij wordt de context van de waarschuwing naar het runbook verzonden.</span><span class="sxs-lookup"><span data-stu-id="d8ced-147">When the service stops, the alert rule in Log Analytics will detect a match and trigger the runbook and send the alert context to the runbook.</span></span> <span data-ttu-id="d8ced-148">Het runbook onderneemt actie om te controleren of de service daadwerkelijk is gestopt. Als dat het geval is, wordt geprobeerd de service opnieuw te starten, wordt gecontroleerd of de service is gestart en worden de resultaten uitgevoerd.</span><span class="sxs-lookup"><span data-stu-id="d8ced-148">The runbook will take action to verify the service is stopped, and if so attempt to restart the service and verify it started correctly and output the results.</span></span>     

<span data-ttu-id="d8ced-149">Als u uw Automation-account niet hebt gekoppeld aan uw OMS-werkruimte, configureert u de waarschuwingsregel met een webhookactie die het runbook activeert, en configureert u het runbook om de tekenreeks in JSON-indeling te converteren en om te filteren op *.SearchResult* volgens de eerder vermelde richtlijnen.</span><span class="sxs-lookup"><span data-stu-id="d8ced-149">Alternatively if you don't have your Automation account linked to your OMS workspace, you would configure the alert rule with a webhook action to trigger the runbook and configure the runbook to convert the JSON-formatted string and filter on *.SearchResult* following the guidance mentioned earlier.</span></span>    

## <a name="next-steps"></a><span data-ttu-id="d8ced-150">Volgende stappen</span><span class="sxs-lookup"><span data-stu-id="d8ced-150">Next steps</span></span>

* <span data-ttu-id="d8ced-151">Voor meer informatie over waarschuwingen in Log Analytics en het maken van een waarschuwing raadpleegt u [Alerts in Log Analytics](../log-analytics/log-analytics-alerts.md) (Waarschuwingen in Log Analytics).</span><span class="sxs-lookup"><span data-stu-id="d8ced-151">To learn more about alerts in Log Analytics and how to create one, see [Alerts in Log Analytics](../log-analytics/log-analytics-alerts.md).</span></span>

* <span data-ttu-id="d8ced-152">Als u wilt weten hoe u runbooks activeert met een webhook, raadpleegt u [Azure Automation-webhooks](automation-webhooks.md).</span><span class="sxs-lookup"><span data-stu-id="d8ced-152">To understand how to trigger runbooks using a webhook, see [Azure Automation webhooks](automation-webhooks.md).</span></span>
